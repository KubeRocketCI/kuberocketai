# Story 08.01: Selective Agent Installation Core

## Status

| Field                  | Value                       |
|------------------------|-----------------------------|
| Status                 | Ready for Implementation    |
| Epic                   | Epic 8: Selective Installation |
| Priority               | High                        |
| Estimated Story Points | 5                           |
| Jira                   | [To be assigned]            |

## Dependencies

**Blocking:**

- Story 08.02 (depends on core installation functionality)

**Blocked By:**

- Epic 1: KubeRocketAI Baseline (core CLI infrastructure)
- Epic 2: Core Engine (dependency resolution capabilities)

**System/Test Dependencies:**

- Golang 1.24+ runtime environment
- File system write permissions for `.krci-ai/` directory
- Embedded framework assets for offline installation

## Story

**As an** Enterprise Development Lead,
**I want** to install specific agents using the same flexible syntax as bundle commands (comma or space separated),
**so that** I can customize my team's framework setup without unnecessary bloat and maintain CLI consistency.

## Acceptance Criteria

1. Single agent installation with dependency resolution
   - Scenario: Given a valid agent name, when I run single agent installation command, then only the specified agent and its required dependencies are installed
   - Expected Behavior: Installation creates .krci-ai directory with only requested agent and dependency files; no extra agents installed
   - Verification Command: `krci-ai install --agent developer && find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: exit 0, count = 1)
   - Evidence: Command output showing successful installation and directory listing
   - Non-automatable at story-level: false
   - Files Created/Changed: `.krci-ai/agents/developer.yaml`, `.krci-ai/tasks/*.md` (dependencies)
   - Guardrails: Installation completes in <= 10s; no P0/P1 errors; maintains directory structure consistency
   - Test Data/Fixtures: Embedded agent definitions in binary
   - Environment/Flags: None required
   - Traceability: Epic AC #1; BR13

2. Multi-agent installation using flexible syntax (matches bundle command)
   - Scenario: Given multiple valid agent names, when I run installation with comma-separated or space-separated syntax, then all specified agents and dependencies are installed
   - Expected Behavior: Exactly specified agents installed with proper dependency resolution; supports both "pm,architect,developer" and "pm architect developer" formats
   - Verification Command: `krci-ai install --agent pm,architect,developer && find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: exit 0, count = 3)
   - Evidence: Directory listing showing all requested agents and verification of both comma and space-separated parsing
   - Non-automatable at story-level: false
   - Files Created/Changed: `.krci-ai/agents/pm.yaml`, `.krci-ai/agents/architect.yaml`, `.krci-ai/agents/developer.yaml`, related task files
   - Guardrails: All agents installed successfully or rollback on failure; no orphaned dependencies; both parsing formats work identically
   - Test Data/Fixtures: Multiple agent definitions; test both "pm,architect" and "pm architect" formats
   - Environment/Flags: None required
   - Traceability: Epic AC #2; BR14

3. Dependency resolution validation
   - Scenario: Given agents with task dependencies, when selective installation occurs, then all required tasks and data files are included automatically
   - Expected Behavior: Agent functionality preserved through complete dependency chain installation
   - Verification Command: `krci-ai validate --agent developer` (Expect: exit 0, "validation passed")
   - Evidence: Validation output confirming all dependencies satisfied
   - Non-automatable at story-level: false
   - Files Created/Changed: All dependency files as specified in agent configurations
   - Guardrails: No broken references; agent remains fully functional post-installation
   - Test Data/Fixtures: Agent configurations with multi-level dependencies
   - Environment/Flags: None required
   - Traceability: Epic dependency requirements; BR13, BR14

4. Installation error handling and rollback
   - Scenario: Given an invalid agent name or installation failure, when installation is attempted, then clear error message is shown and system remains clean
   - Expected Behavior: Graceful failure with actionable error message; no partial installation state
   - Verification Command: `krci-ai install --agent invalid_agent` (Expect: exit 1, error message in stderr)
   - Evidence: Error output and verification of clean filesystem state
   - Non-automatable at story-level: false
   - Files Created/Changed: None (clean rollback)
   - Guardrails: No corrupted state; clear error messaging; complete rollback on failure
   - Test Data/Fixtures: Invalid agent names and corrupted scenarios
   - Environment/Flags: None required
   - Traceability: NFR-UX1, NFR-REL

## Description

This story implements the core selective installation functionality for KubeRocketAI, enabling Enterprise Development Leads to install only the agents they need for their team's specific workflows. This addresses the primary Epic 8 goal of eliminating unnecessary bloat while maintaining full compatibility with existing validation and bundling systems.

**Technical Implementation Approach**:

The implementation leverages existing codebase patterns and reuses proven parsing logic from the bundle command system. The `--agent` flag follows identical syntax patterns as bundle commands, accepting both comma-separated (`pm,architect`) and space-separated (`"pm architect"`) formats using the existing `ParseAgentList()` function from `bundle.go:103-129`.

**Architecture Integration Points**:

- **CLI Layer**: Extends `install.go` with new `--agent` flag using cobra framework patterns
- **Parsing Layer**: Reuses `ParseAgentList()` and `validateAgentNames()` functions from bundle command
- **Asset Layer**: Extends `assets.Installer` with selective extraction methods using existing discovery service
- **Validation Layer**: Integrates with existing validation system to ensure complete dependency resolution

**Key Libraries and Dependencies**:

- Library: `github.com/spf13/cobra v1.9.1` (CLI framework - already available)
- Library: `gopkg.in/yaml.v3 v3.0.1` (YAML parsing - already available)
- Library: `github.com/fatih/color v1.17.0` (CLI output styling - already available)

**File Structure and Integration**:

- Primary Changes: `cmd/krci-ai/cmd/install.go` (extend existing install command)
- Core Logic: `internal/assets/installer.go` (add selective installation methods)
- Error Handling: `internal/cli/errors.go` (extend existing error handling patterns)
- Discovery Integration: Reuse `internal/assets/discovery.go` service for agent resolution

**Test Files to Create**:

- `cmd/krci-ai/cmd/install_selective_test.go` - CLI flag and command integration tests
- `cmd/krci-ai/cmd/install_integration_test.go` - Cross-command integration tests
- `internal/assets/installer_selective_test.go` - Selective installation logic tests
- `internal/assets/installer_errors_test.go` - Error handling and rollback tests

**E2E Testing Strategy**:
All binary tests execute within isolated `e2e-test` subdirectories to ensure:

- Complete test isolation from main project directory
- Clean state for each test execution
- Proper cleanup after test completion
- No interference between different test scenarios

**Dependency Resolution Strategy**:
The implementation uses the existing `assets.Discovery.DiscoverAgentsWithDependencies()` method to ensure complete dependency chains are resolved, filtering results to only include requested agents and their required tasks, templates, and data files.

The story focuses on fundamental installation capabilities (single and multi-agent installation with complete dependency resolution) that serve as the foundation for the advanced features in Story 8.02.

## Tasks/Subtasks

- [ ] **Task 1: Implement CLI argument parsing using bundle command pattern (AC: 1, 2)**
  - [ ] Create/Edit file: `cmd/krci-ai/cmd/install.go` - add `--agent` flag definition in init() function (line ~196-206)
  - [ ] Purpose: Add flag using cobra patterns matching bundle command structure exactly
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - import bundle parsing functions at top of file
  - [ ] Purpose: Reuse existing `ParseAgentList()` and `validateAgentNames()` functions from bundle.go
  - [ ] Create file: `cmd/krci-ai/cmd/install_selective_test.go` - add unit tests for new --agent flag
  - [ ] Purpose: Test flag definition, help text, and basic validation following existing test patterns
  - [ ] Unit Tests Required:
    - [ ] `TestInstallCommandHasAgentFlag()` - verify --agent flag exists with correct shorthand
    - [ ] `TestInstallAgentFlagHelp()` - verify help text documents comma/space syntax
    - [ ] `TestInstallAgentFlagValidation()` - test flag parsing and validation logic
  - [ ] Run: `go build -o dist/krci-ai cmd/krci-ai/main.go` (follow Makefile build pattern)
  - [ ] Run: `make ci` (Expect: all CI checks pass including new tests)
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Verify: `../dist/krci-ai install --help | grep -E "(--agent.*comma.*space)"` (Expect: flag documented with parsing syntax)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: Flag implemented with full test coverage, all CI checks pass

- [ ] **Task 2: Integrate selective discovery and validation (AC: 1, 2, 3)**
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - add agent parsing logic in Run function (after line 83)
  - [ ] Purpose: Parse and validate selected agents using existing bundle command patterns
  - [ ] Integration: Use `ParseAgentList(agentFlag)` and `validateAgentNames(currentDir, agents, output)` functions
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - modify installer.Install() call to accept agent filter
  - [ ] Purpose: Pass selected agents to installation process for filtering
  - [ ] Edit file: `cmd/krci-ai/cmd/install_selective_test.go` - add integration tests for parsing logic
  - [ ] Unit Tests Required:
    - [ ] `TestParseAgentListIntegration()` - test comma and space-separated parsing
    - [ ] `TestValidateAgentNamesIntegration()` - test agent validation with mock discovery
    - [ ] `TestInstallSelectiveFlow()` - test conditional routing to selective installation
  - [ ] Run: `go test ./cmd/krci-ai/cmd/ -v` (run existing tests to ensure no regressions)
  - [ ] Run: `make ci` (Expect: all CI checks pass with new integration tests)
  - [ ] Verify: `echo $?` (Expect: 0 - all tests pass)
  - [ ] Success Criteria: Agent parsing integrated with full test coverage, no regressions

- [ ] **Task 3: Extend installer with selective installation methods (AC: 1, 3)**
  - [ ] Edit file: `internal/assets/installer.go` - add InstallSelective() method after Install() method (~line 200)
  - [ ] Purpose: Implement selective asset extraction using discovery service with agent filtering
  - [ ] Implementation: Use `discovery.DiscoverAgentsWithDependencies()` filtered by `FilterAgentsByNames()`
  - [ ] Edit file: `internal/assets/installer.go` - add agent filtering logic in asset extraction
  - [ ] Purpose: Extract only agents and dependencies specified, maintaining dependency chain integrity
  - [ ] Integration: Reuse existing extraction patterns from Install() method but with filtered asset list
  - [ ] Edit file: `internal/assets/installer_selective_test.go` - create comprehensive unit tests for selective methods
  - [ ] Unit Tests Required:
    - [ ] `TestInstallSelective()` - test selective installation with various agent combinations
    - [ ] `TestInstallSelectiveDependencyResolution()` - verify complete dependency chains included
    - [ ] `TestInstallSelectiveFileFiltering()` - test correct file extraction and filtering
    - [ ] `TestInstallSelectiveErrorHandling()` - test error scenarios and rollback
  - [ ] Run: `go test ./internal/assets/ -v -coverprofile=coverage.out` (verify full test coverage)
  - [ ] Run: `make ci` (Expect: all CI checks pass with new selective installation tests)
  - [ ] Verify: `go tool cover -func=coverage.out | grep InstallSelective` (Expect: >90% coverage for new methods)
  - [ ] Success Criteria: Selective installation implemented with comprehensive test coverage, all CI checks pass

- [ ] **Task 4: Implement single agent installation logic (AC: 1)**
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - add conditional logic for selective vs full installation
  - [ ] Purpose: Route to selective installation when --agent flag is provided
  - [ ] Logic: `if agentFlag != "" { installer.InstallSelective(agents) } else { installer.Install() }`
  - [ ] Edit file: `internal/assets/installer.go` - ensure single agent dependency resolution works
  - [ ] Purpose: Verify single agent includes all required tasks, templates, and data files
  - [ ] Edit file: `cmd/krci-ai/cmd/install_selective_test.go` - add single agent installation tests
  - [ ] Unit Tests Required:
    - [ ] `TestSingleAgentInstallation()` - test complete single agent installation flow
    - [ ] `TestSingleAgentDependencies()` - verify all required dependencies included
    - [ ] `TestSingleAgentFileStructure()` - validate correct .krci-ai directory structure
  - [ ] Run: `go build -o dist/krci-ai cmd/krci-ai/main.go`
  - [ ] Run: `make ci` (Expect: all CI checks pass with single agent installation tests)
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Verify: `../dist/krci-ai install --agent developer && test -f .krci-ai/agents/developer.yaml && find .krci-ai/tasks -name "*.md" | wc -l` (Expect: developer.yaml exists, task files present)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: Single agent installation implemented with complete test coverage, all CI checks pass

- [ ] **Task 5: Implement multi-agent installation with syntax support (AC: 2)**
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - ensure ParseAgentList() handles both comma and space separation
  - [ ] Purpose: Support both "pm,architect,developer" and "pm architect developer" formats identically
  - [ ] Validation: Use existing validateAgentNames() to ensure all specified agents exist
  - [ ] Edit file: `internal/assets/installer.go` - optimize multi-agent dependency resolution
  - [ ] Purpose: Ensure efficient installation of multiple agents with shared dependencies
  - [ ] Implementation: Deduplicate shared tasks/templates/data files across multiple agents
  - [ ] Edit file: `cmd/krci-ai/cmd/install_selective_test.go` - add multi-agent installation tests
  - [ ] Unit Tests Required:
    - [ ] `TestMultiAgentInstallationComma()` - test comma-separated agent installation
    - [ ] `TestMultiAgentInstallationSpace()` - test space-separated agent installation
    - [ ] `TestMultiAgentDependencyDeduplication()` - verify shared dependencies handled correctly
    - [ ] `TestMultiAgentSyntaxEquivalence()` - verify both formats produce identical results
  - [ ] Run: `go build -o dist/krci-ai cmd/krci-ai/main.go`
  - [ ] Run: `make ci` (Expect: all CI checks pass with multi-agent installation tests)
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Verify: `../dist/krci-ai install --agent pm,developer && find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: count = 2)
  - [ ] Verify: `../dist/krci-ai install --agent "pm architect" --force && find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: count = 2, space-separated works)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: Both syntax formats implemented with comprehensive test coverage, all CI checks pass

- [ ] **Task 6: Add comprehensive error handling and rollback (AC: 4)**
  - [ ] Edit file: `internal/assets/installer.go` - add validation for agent names before installation begins
  - [ ] Purpose: Fail fast with clear error messages for invalid agent names
  - [ ] Edit file: `internal/assets/installer.go` - implement rollback logic for partial installation failures
  - [ ] Purpose: Ensure clean state if installation fails midway (remove partial .krci-ai directory)
  - [ ] Edit file: `internal/cli/errors.go` - add agent-specific error messages following existing patterns
  - [ ] Purpose: Provide actionable error messages with available agent suggestions
  - [ ] Create file: `internal/assets/installer_errors_test.go` - comprehensive error handling tests
  - [ ] Unit Tests Required:
    - [ ] `TestInstallSelectiveInvalidAgent()` - test error handling for invalid agent names
    - [ ] `TestInstallSelectiveRollback()` - test complete rollback on installation failure
    - [ ] `TestInstallSelectiveErrorMessages()` - verify clear, actionable error messages
    - [ ] `TestInstallSelectivePartialFailure()` - test handling of partial installation failures
  - [ ] Run: `go test ./internal/assets/ ./internal/cli/ -v -coverprofile=coverage.out` (verify comprehensive error test coverage)
  - [ ] Run: `make ci` (Expect: all CI checks pass with error handling tests)
  - [ ] Verify: `go tool cover -func=coverage.out | grep -E "(error|rollback)"` (Expect: >95% coverage for error paths)
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Verify: `../dist/krci-ai install --agent invalid_agent; echo $?` (Expect: exit code 1, clear error message)
  - [ ] Verify: `test ! -d .krci-ai` (Expect: no partial installation directory left behind)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: Comprehensive error handling with full test coverage, all CI checks pass

- [ ] **Task 7: Integration testing with existing validation system (AC: 3)**
  - [ ] Create file: `cmd/krci-ai/cmd/install_integration_test.go` - comprehensive integration tests
  - [ ] Unit Tests Required:
    - [ ] `TestSelectiveInstallationWithValidation()` - test install + validate command integration
    - [ ] `TestSelectiveInstallationWithBundle()` - test install + bundle command integration
    - [ ] `TestSelectiveInstallationCrossCommand()` - test compatibility across all commands
    - [ ] `TestSelectiveInstallationIDEIntegration()` - test selective installation with IDE integrations
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Run: `../dist/krci-ai install --agent developer && ../dist/krci-ai validate --agent developer`
  - [ ] Purpose: Verify selective installation works with existing validation command
  - [ ] Verify: `echo $?` (Expect: 0 - validation passes with all dependencies satisfied)
  - [ ] Run: `../dist/krci-ai install --agent pm,architect --force && ../dist/krci-ai validate`
  - [ ] Purpose: Verify multi-agent installation passes framework validation
  - [ ] Verify: `echo $?` (Expect: 0 - complete framework validation passes)
  - [ ] Run: `../dist/krci-ai install --agent developer --force && ../dist/krci-ai bundle --agent developer`
  - [ ] Purpose: Verify selective installation works with existing bundle command
  - [ ] Verify: `test -f .krci-ai/bundle/developer.md` (Expect: bundle generation works with selective installation)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Run: `go test ./cmd/krci-ai/cmd/ -v -run Integration` (run integration tests specifically)
  - [ ] Run: `make ci` (Expect: complete CI pipeline passes with all integration tests)
  - [ ] Success Criteria: Selective installations integrate seamlessly with existing commands, full test coverage

## Implementation Results

To be populated after implementation

## QA Checklist

### Functional Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Single Agent Installation**: `../dist/krci-ai install --agent developer` (Expect: success, only developer agent installed, exit 0)
- [ ] **Agent File Verification**: `test -f .krci-ai/agents/developer.yaml && find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: file exists, count = 1)
- [ ] **Multi-Agent Installation (Comma)**: `../dist/krci-ai install --agent pm,architect,developer --force` (Expect: success, exactly 3 agents, exit 0)
- [ ] **Multi-Agent File Verification**: `find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: count = 3)
- [ ] **Multi-Agent Installation (Space)**: `../dist/krci-ai install --agent "pm architect developer" --force` (Expect: success, exactly 3 agents, exit 0)
- [ ] **Space Syntax Verification**: `find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: count = 3, identical to comma syntax)
- [ ] **Dependency Resolution**: `../dist/krci-ai validate --agent developer` (Expect: all dependencies satisfied, exit 0)
- [ ] **Full Framework Validation**: `../dist/krci-ai validate` (Expect: complete validation passes, exit 0)
- [ ] **Error Handling**: `../dist/krci-ai install --agent nonexistent` (Expect: clear error message, exit 1)
- [ ] **Clean State Verification**: `test ! -d .krci-ai` (Expect: no partial installation directory after error)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### Integration Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Validation Compatibility**: `../dist/krci-ai install --agent developer && ../dist/krci-ai validate` (Expect: exit 0, validation passes)
- [ ] **Bundle Compatibility**: `../dist/krci-ai install --agent pm --force && ../dist/krci-ai bundle --agent pm` (Expect: exit 0, bundle created)
- [ ] **CLI Consistency**: `../dist/krci-ai install --help | grep -E "(--agent.*comma.*space)"` (Expect: consistent help documentation)
- [ ] **IDE Integration**: `../dist/krci-ai install --agent developer --ide=cursor --force` (Expect: selective + IDE integration works)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### CI Pipeline Validation

- [ ] **Complete CI Pipeline**: `make ci` (Expect: exit 0, all checks pass - deps, fmt, vet, lint, staticcheck, test, build)
- [ ] **Test Coverage Verification**: `go test ./... -coverprofile=coverage.out && go tool cover -func=coverage.out` (Expect: >90% coverage for new code)
- [ ] **Linting Compliance**: `make lint` (Expect: exit 0, no linting errors for new code)
- [ ] **Static Analysis**: `make staticcheck` (Expect: exit 0, no static analysis issues)
- [ ] **Formatting Compliance**: `make fmt` (Expect: no formatting changes needed)
- [ ] **Build Verification**: `make build` (Expect: exit 0, binary created successfully)

### Unit Test Validation

- [ ] **Test File Coverage**: All new functionality has dedicated test files (*_test.go)
- [ ] **Function Coverage**: All new public functions covered by unit tests
- [ ] **Error Path Coverage**: All error scenarios tested with appropriate assertions
- [ ] **Edge Case Coverage**: Invalid inputs, boundary conditions, and failure modes tested
- [ ] **Integration Points**: All interactions with existing code covered by integration tests

### Cross-Story Integration Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Story 8.02 Foundation**: Core installation provides foundation for advanced features (Expect: 8.01 agents work with 8.02 task filtering)
- [ ] **Progressive Enhancement**: `../dist/krci-ai install --agent pm` then future `../dist/krci-ai install --agent pm --task create-prd` works correctly
- [ ] **Validation Chain**: Core installations validated before advanced operations (Expect: 8.01 validation supports 8.02 advanced scenarios)
- [ ] **Command Consistency**: Core flags work identically in advanced scenarios (Expect: `--agent` parsing consistent between 8.01 and 8.02)
- [ ] **Dependency Preservation**: Core dependency resolution supports advanced task filtering (Expect: agent dependencies maintained during task-specific installations)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### Performance Testing

- [ ] **Installation Speed**: Single agent installation completes in <= 10s
- [ ] **Multi-Agent Scaling**: Installation time scales linearly with agent count
- [ ] **Memory Usage**: No memory leaks during installation process

### Security & Privacy

- [ ] **File Permissions**: Installed files have appropriate permissions
- [ ] **Path Validation**: No path traversal vulnerabilities in agent names
- [ ] **Clean Rollback**: Failed installations leave no partial state

### Edge Case Testing

- [ ] **Invalid Agent Names**: Test with malformed agent names (Expect: input validation, clear errors)
- [ ] **Invalid Flag Combinations**: Test with incompatible flag combinations (Expect: clear validation errors)
