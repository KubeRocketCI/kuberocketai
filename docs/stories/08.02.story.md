# Story 08.02: Advanced Selective Installation

## Status

| Field                  | Value                       |
|------------------------|-----------------------------|
| Status                 | Approved                    |
| Epic                   | Epic 8: Selective Installation |
| Priority               | Medium                      |
| Estimated Story Points | 3                           |
| Jira                   | [To be assigned]            |

## Dependencies

**Blocking:**

- None

**Blocked By:**

- Story 08.01: Selective Agent Installation Core

**System/Test Dependencies:**

- Agent-task validation system (implemented in 08.01)
- Task dependency mapping system (implemented in 08.01)
- IDE integration with selective installation (implemented in 08.01)

## Story

**As a** Focused Developer,
**I want** enhanced task validation and advanced error handling for selective installations,
**so that** I can confidently install precise agent-task combinations with clear guidance when errors occur.

**Note**: Core `--task` functionality already implemented in Story 08.01.

## Acceptance Criteria

**Note**: Story 08.01 already implemented core functionality including `--task` flag, validation, and IDE integration. This story focuses on enhancement gaps.

1. Enhanced agent-task validation with suggestions
   - Scenario: Given invalid agent-task combinations, when installation is attempted, then clear validation errors provide available task suggestions
   - Expected Behavior: Pre-validation prevents invalid combinations; lists available tasks for specified agent
   - Verification Command: `krci-ai install --agent pm --task implement-feature` (Expect: exit 1, "task not available" error with suggestions)
   - Evidence: Error output showing available tasks for the agent
   - Non-automatable at story-level: false
   - Files Created/Changed: None (validation failure)
   - Guardrails: Clear error messages; helpful suggestions provided
   - Test Data/Fixtures: Agent-task mapping validation scenarios
   - Environment/Flags: None required
   - Traceability: NFR-UX1

2. Multi-task comma-separated syntax validation
   - Scenario: Given comma-separated task lists, when validation occurs, then each task is individually validated against the agent
   - Expected Behavior: Specific validation for each task in comma-separated list; partial failures identified clearly
   - Verification Command: `krci-ai install --agent pm --task create-prd,invalid-task,update-prd` (Expect: exit 1, identifies "invalid-task")
   - Evidence: Error output showing which specific tasks are invalid
   - Non-automatable at story-level: false
   - Files Created/Changed: None (validation failure)
   - Guardrails: Precise error identification; no partial installations
   - Test Data/Fixtures: Mixed valid/invalid task combinations
   - Environment/Flags: None required
   - Traceability: NFR-UX1

3. Advanced error messaging with recovery guidance
   - Scenario: Given various error conditions, when installation fails, then specific recovery guidance is provided
   - Expected Behavior: Context-specific error messages; actionable recovery steps; clean rollback
   - Verification Command: Various error scenarios with recovery guidance validation
   - Evidence: Clear error messages with specific recovery instructions
   - Non-automatable at story-level: false
   - Files Created/Changed: None (clean rollback)
   - Guardrails: No partial state; helpful recovery guidance
   - Test Data/Fixtures: Multiple error scenarios
   - Environment/Flags: None required
   - Traceability: NFR-UX1, NFR-REL

## Description

Enhances the selective installation system from Story 08.01 with improved validation and error handling. Since core `--task` functionality and IDE integration are already implemented, this story focuses on user experience improvements and robust error scenarios.

The implementation builds on the solid foundation from 08.01, adding enhanced validation feedback and recovery guidance for edge cases.

**Technical Implementation Foundation**:

This story builds directly on Story 08.01's selective installation infrastructure, extending the `--agent` functionality with complementary `--task` and enhanced `--ide` capabilities. The implementation leverages existing Bundle command patterns for consistency and reuses proven parsing logic.

**Architecture Integration Points**:

- **CLI Layer**: Extends `install.go` with `--task` flag using existing comma-separated parsing patterns from `bundle.go:ParseAgentList()`
- **Installation Layer**: Builds on Story 08.01's `InstallSelective()` method to add task-level filtering
- **IDE Integration Layer**: Enhances existing IDE integration system to handle selective installations with task-specific configurations
- **Validation Layer**: Extends validation system to handle agent-task compatibility and task dependency resolution

**Key Libraries and Dependencies**:

- Library: `github.com/spf13/cobra v1.9.1` (CLI framework - already available)
- Library: `gopkg.in/yaml.v3 v3.0.1` (YAML parsing for agent-task mapping - already available)
- Library: `github.com/fatih/color v1.17.0` (CLI output styling - already available)

**File Structure and Integration**:

- Primary Changes: `cmd/krci-ai/cmd/install.go` (add `--task` flag and task filtering logic)
- Core Logic: `internal/assets/installer.go` (extend Story 08.01's selective installation with task filtering)
- Task Management: `internal/assets/task_resolver.go` (new - task dependency resolution and validation)
- IDE Enhancement: `internal/assets/installer.go` (enhance existing IDE integration for selective installations)

**Test Files to Create**:

- `cmd/krci-ai/cmd/install_advanced_test.go` - Advanced CLI flag combinations and task filtering tests
- `cmd/krci-ai/cmd/install_ide_integration_test.go` - IDE integration with selective installations tests
- `internal/assets/task_resolver_test.go` - Task dependency resolution and validation tests
- `internal/assets/installer_advanced_test.go` - Advanced selective installation logic tests

**E2E Testing Strategy**:
All binary tests execute within isolated `e2e-test` subdirectories building on Story 08.01's testing patterns to ensure:

- Complete test isolation with task-specific scenarios
- Clean state for complex dependency testing
- IDE integration validation in isolated environments
- Multi-flag combination testing with proper cleanup

**Agent-Task Dependency Resolution Strategy**:
The implementation analyzes agent YAML definitions to extract task lists (e.g., PM agent: `create-prd.md`, `update-prd.md`) and validates task specifications against available tasks. Task dependencies are resolved through existing template/data reference parsing with enhanced validation for task-specific installations.

**IDE Integration Enhancement Strategy**:
Builds on existing IDE integration patterns (`CursorIntegration`, `ClaudeIntegration`, etc.) to generate IDE configurations that reflect only installed agents and their specified tasks, ensuring IDE environments match the selective installation scope.

The story maintains CLI consistency with the bundle command by using a single `--task` flag that supports comma-separated task lists (`create-prd,update-prd`). This extends the bundle pattern while preserving the familiar syntax and leveraging existing parsing approaches.

## Tasks/Subtasks

**Note**: Core functionality already implemented in Story 08.01. This story focuses on validation improvements.

- [ ] **Task 1: Enhance agent-task validation with suggestions (AC: 1)**
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - enhance task validation to provide available task suggestions
  - [ ] Purpose: Improve error messages when invalid agent-task combinations are specified
  - [ ] Add logic to parse agent YAML files and suggest valid tasks when validation fails
  - [ ] Test: `krci-ai install --agent pm --task implement-feature` (Expect: "available tasks: create-prd, update-prd, ...")
  - [ ] Run: `make ci` (Expect: enhanced validation tests pass)

- [ ] **Task 2: Implement multi-task validation (AC: 2)**
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - enhance comma-separated task parsing to validate each task individually
  - [ ] Purpose: Provide specific feedback when some tasks in a comma-separated list are invalid
  - [ ] Test: `krci-ai install --agent pm --task create-prd,invalid-task,update-prd` (Expect: identifies "invalid-task" specifically)
  - [ ] Run: `make ci` (Expect: individual task validation works correctly)

- [ ] **Task 3: Add advanced error messaging with recovery guidance (AC: 3)**
  - [ ] Edit file: `internal/cli/errors.go` - add context-specific error messages with recovery steps
  - [ ] Purpose: Provide actionable guidance for common error scenarios
  - [ ] Add recovery instructions for invalid combinations, missing agents, etc.
  - [ ] Test various error scenarios to ensure helpful messaging
  - [ ] Run: `make ci` (Expect: error handling improvements work correctly)

## Implementation Results

**Status**: Approved - Scope Reduced

Since Story 08.01 already implemented:

- `--task` flag with comma-separated syntax
- Agent-task dependency validation
- IDE integration with selective installation
- Error handling and rollback

This story's scope is significantly reduced to focus only on enhanced validation messaging and user experience improvements.

## QA Checklist

### Functional Testing

**Note**: Core functionality already working from 08.01. Focus on validation improvements.

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Enhanced Validation Messages**: `../dist/krci-ai install --agent pm --task implement-feature` (Expect: exit 1, error shows available tasks for PM agent)
- [ ] **Multi-Task Error Identification**: `../dist/krci-ai install --agent pm --task create-prd,invalid-task,update-prd` (Expect: specifically identifies "invalid-task")
- [ ] **Recovery Guidance**: Error messages include actionable recovery steps (Expect: clear guidance on valid combinations)
- [ ] **Validation Consistency**: All error scenarios provide helpful, consistent messaging

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### Integration Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Story 8.01 Compatibility**: `../dist/krci-ai install --agent pm && ../dist/krci-ai install --agent developer --task implement-feature --force` (Expect: both installations coexist)
- [ ] **Multi-Agent Verification**: `find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: count = 2, both agents installed)
- [ ] **IDE Integration Compatibility**: `../dist/krci-ai install --agent pm --task create-prd --ide cursor --force && ../dist/krci-ai install --agent developer --ide cursor --force` (Expect: multiple IDE configs coexist)
- [ ] **IDE Multi-Agent Verification**: `find .cursor/rules/krci-ai -name "*.mdc" | wc -l` (Expect: multiple agent IDE configs)
- [ ] **Validation Compatibility**: `../dist/krci-ai validate` (Expect: exit 0, advanced installations pass existing validation)
- [ ] **Bundle Command Compatibility**: `../dist/krci-ai bundle --agent pm --task create-prd` (Expect: exit 0, task filtering works with bundle)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### CI Pipeline Validation

- [ ] **Complete CI Pipeline**: `make ci` (Expect: exit 0, all checks pass - deps, fmt, vet, lint, staticcheck, test, build)
- [ ] **Test Coverage Verification**: `go test ./... -coverprofile=coverage.out && go tool cover -func=coverage.out` (Expect: >90% coverage for new advanced features)
- [ ] **Linting Compliance**: `make lint` (Expect: exit 0, no linting errors for new advanced features)
- [ ] **Static Analysis**: `make staticcheck` (Expect: exit 0, no static analysis issues)
- [ ] **Formatting Compliance**: `make fmt` (Expect: no formatting changes needed)
- [ ] **Build Verification**: `make build` (Expect: exit 0, binary created successfully)

### Unit Test Validation

- [ ] **Test File Coverage**: All new advanced functionality has dedicated test files (*_test.go)
- [ ] **Function Coverage**: All new public functions in task_resolver.go and advanced installation covered
- [ ] **Error Path Coverage**: All advanced error scenarios tested with appropriate assertions
- [ ] **Edge Case Coverage**: Invalid task combinations, IDE failures, and complex dependency scenarios tested
- [ ] **Integration Points**: All interactions with Story 08.01 foundation covered by integration tests

### Combined Feature Integration Testing

**Note**: Since core features are already working from 08.01, no additional integration testing needed.

This section would only be relevant if we were implementing new major features. Since we're only enhancing validation messages, the existing integration tests from 08.01 cover the functionality.

### Epic-Level Integration Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Epic Acceptance Criteria Fulfillment**: All Epic 8 ACs validated through story combinations (install selective agents + install with tasks + IDE integration)
- [ ] **Bundle Command Consistency**: `../dist/krci-ai install --agent pm --task create-prd && ../dist/krci-ai bundle --agent pm --task create-prd` (Expect: same agents/tasks work in both commands)
- [ ] **Framework Compatibility**: `../dist/krci-ai install --agent pm --task create-prd --ide cursor && ../dist/krci-ai validate && ../dist/krci-ai list agents` (Expect: no regression in existing functionality)
- [ ] **User Journey Completion**: Complete Epic 8 user stories validation (Enterprise Development Lead + Focused Developer can achieve all goals)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### Performance Testing

- [ ] **Task Installation Speed**: Task-specific installation completes in <= 15s
- [ ] **IDE Integration Speed**: IDE configuration completes in <= 20s
- [ ] **Complex Dependency Resolution**: Handles complex dependency graphs efficiently

### Security & Privacy

- [ ] **Task Validation**: Task names validated to prevent path traversal
- [ ] **IDE Configuration Security**: IDE files created with appropriate permissions
- [ ] **Dependency Integrity**: Task dependencies verified for integrity

### Edge Case Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Invalid Task Lists**: Proper handling of various invalid task combinations
- [ ] **Mixed Valid/Invalid Tasks**: Clear identification of problematic tasks in lists
- [ ] **Agent Without Tasks**: Graceful handling of agents with no available tasks
- [ ] **Empty Task Specifications**: Proper validation of empty or malformed task arguments

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)
