# Story 08.02: Advanced Selective Installation

## Status

| Field                  | Value                       |
|------------------------|-----------------------------|
| Status                 | Ready for Implementation    |
| Epic                   | Epic 8: Selective Installation |
| Priority               | High                        |
| Estimated Story Points | 8                           |
| Jira                   | [To be assigned]            |

## Dependencies

**Blocking:**

- None

**Blocked By:**

- Story 08.01: Selective Agent Installation Core (core installation functionality required)
- Epic 4: IDE Integration (IDE integration patterns and capabilities)

**System/Test Dependencies:**

- Supported IDE versions (Cursor, VS Code, JetBrains)
- Task dependency mapping system
- Agent-task relationship definitions

## Story

**As a** Focused Developer,
**I want** to install agents with specific tasks using consistent CLI syntax (--task with comma-separated support) and IDE integration,
**so that** I can have a precisely configured development environment while maintaining CLI consistency with bundle commands.

## Acceptance Criteria

1. Task-specific installation filtering
   - Scenario: Given an agent with multiple tasks, when I specify a subset of tasks during installation, then only the specified tasks and their dependencies are installed
   - Expected Behavior: Agent installed with only requested tasks; unused tasks excluded; agent functionality preserved
   - Verification Command: `krci-ai install --agent pm --task create-prd,update-prd && find .krci-ai/tasks -name "*prd*.md" | wc -l` (Expect: exit 0, count = 2)
   - Evidence: Directory listing showing only specified tasks and validation of agent functionality
   - Non-automatable at story-level: false
   - Files Created/Changed: `.krci-ai/agents/pm.yaml`, `.krci-ai/tasks/create-prd.md`, `.krci-ai/tasks/update-prd.md`
   - Guardrails: Agent remains functional; task dependencies intact; no broken references; installation completes in <= 15s
   - Test Data/Fixtures: PM agent with multiple tasks (create-prd, update-prd, create-epic, gather-requirements)
   - Environment/Flags: None required
   - Traceability: Epic AC #3; BR15

2. IDE integration for selective installations
   - Scenario: Given a selective agent installation, when I specify IDE integration during installation, then IDE is configured to work seamlessly with only the installed agents
   - Expected Behavior: IDE shows only installed agents; agent activation works correctly; no missing agent references
   - Verification Command: `krci-ai install --agent developer --ide cursor && krci-ai list --ide cursor | grep -c developer` (Expect: exit 0, count = 1)
   - Evidence: IDE configuration verification and successful agent activation demonstration
   - Non-automatable at story-level: false
   - Files Created/Changed: IDE-specific configuration files (`.cursor/rules/`, `.vscode/settings.json`, etc.)
   - Guardrails: IDE stability maintained; agent functionality preserved; configuration reversible; setup completes in <= 20s
   - Test Data/Fixtures: Developer agent with IDE integration capabilities
   - Environment/Flags: Supported IDE installed and accessible
   - Traceability: Epic AC #4; BR16

3. Complex dependency resolution for partial installations
   - Scenario: Given agents with cross-task dependencies, when I install specific tasks, then all required dependencies are resolved correctly
   - Expected Behavior: Task dependencies satisfied; agent functionality preserved; no missing references
   - Verification Command: `krci-ai install --agent architect --task review-sad,create-sad && krci-ai validate --agent architect --task review-sad,create-sad` (Expect: exit 0, validation passed)
   - Evidence: Validation output confirming all dependencies satisfied and functional verification
   - Non-automatable at story-level: false
   - Files Created/Changed: Agent file, specified task files, dependency data files
   - Guardrails: No broken dependencies; agent functional within specified scope; validation passes
   - Test Data/Fixtures: Architect agent with complex task interdependencies
   - Environment/Flags: None required
   - Traceability: Epic dependency requirements; BR15

4. Advanced installation error handling
   - Scenario: Given invalid task names or IDE configuration failures, when advanced installation is attempted, then clear error messages guide user to resolution
   - Expected Behavior: Specific error messages; suggested corrections; clean rollback state
   - Verification Command: `krci-ai install --agent pm --task invalid-task --ide unsupported-ide` (Expect: exit 1, specific error messages)
   - Evidence: Error output showing clear guidance and verification of clean system state
   - Non-automatable at story-level: false
   - Files Created/Changed: None (clean rollback)
   - Guardrails: No partial state; helpful error messages; rollback completes successfully
   - Test Data/Fixtures: Invalid task names and unsupported IDE configurations
   - Environment/Flags: None required
   - Traceability: NFR-UX1, NFR-REL

5. Invalid agent-task combination handling
   - Scenario: Given an agent and task combination that is invalid (task doesn't belong to agent), when installation is attempted, then clear validation error is provided with suggestions
   - Expected Behavior: Pre-validation detects incompatible combinations; lists available tasks for agent; clean error state
   - Verification Command: `krci-ai install --agent pm --task implement-feature` (Expect: exit 1, "task not available for agent" error)
   - Evidence: Error output showing available tasks for specified agent
   - Non-automatable at story-level: false
   - Files Created/Changed: None (validation failure)
   - Guardrails: Input validation prevents invalid installations; helpful suggestions provided
   - Test Data/Fixtures: Agent-task mapping validation scenarios
   - Environment/Flags: None required
   - Traceability: NFR-UX1, input validation requirements

6. IDE integration failure recovery
   - Scenario: Given IDE configuration failures during installation, when IDE integration fails, then agent installation completes but IDE configuration is cleanly skipped with recovery guidance
   - Expected Behavior: Agent installs successfully; IDE configuration failure isolated; clear guidance for manual IDE setup
   - Verification Command: `krci-ai install --agent developer --ide cursor` (with cursor unavailable) (Expect: exit 0, warning about IDE setup)
   - Evidence: Successful agent installation with IDE warning and manual setup instructions
   - Non-automatable at story-level: false
   - Files Created/Changed: Agent files installed; IDE configuration skipped
   - Guardrails: Installation not blocked by IDE issues; clear recovery path; optional IDE setup
   - Test Data/Fixtures: IDE unavailable scenarios
   - Environment/Flags: IDE not installed or inaccessible
   - Traceability: NFR-REL, NFR-UX1

## Description

This story implements advanced selective installation capabilities that enable Focused Developers to create precisely customized development environments. Building on Story 8.01's core installation functionality, this story adds task-specific filtering and IDE integration to complete the Epic 8 vision of eliminating framework bloat while maximizing development productivity.

**Technical Implementation Foundation**:

This story builds directly on Story 08.01's selective installation infrastructure, extending the `--agent` functionality with complementary `--task` and enhanced `--ide` capabilities. The implementation leverages existing Bundle command patterns for consistency and reuses proven parsing logic.

**Architecture Integration Points**:

- **CLI Layer**: Extends `install.go` with `--task` flag using existing comma-separated parsing patterns from `bundle.go:ParseAgentList()`
- **Installation Layer**: Builds on Story 08.01's `InstallSelective()` method to add task-level filtering
- **IDE Integration Layer**: Enhances existing IDE integration system to handle selective installations with task-specific configurations
- **Validation Layer**: Extends validation system to handle agent-task compatibility and task dependency resolution

**Key Libraries and Dependencies**:

- Library: `github.com/spf13/cobra v1.9.1` (CLI framework - already available)
- Library: `gopkg.in/yaml.v3 v3.0.1` (YAML parsing for agent-task mapping - already available)
- Library: `github.com/fatih/color v1.17.0` (CLI output styling - already available)

**File Structure and Integration**:

- Primary Changes: `cmd/krci-ai/cmd/install.go` (add `--task` flag and task filtering logic)
- Core Logic: `internal/assets/installer.go` (extend Story 08.01's selective installation with task filtering)
- Task Management: `internal/assets/task_resolver.go` (new - task dependency resolution and validation)
- IDE Enhancement: `internal/assets/installer.go` (enhance existing IDE integration for selective installations)

**Test Files to Create**:

- `cmd/krci-ai/cmd/install_advanced_test.go` - Advanced CLI flag combinations and task filtering tests
- `cmd/krci-ai/cmd/install_ide_integration_test.go` - IDE integration with selective installations tests
- `internal/assets/task_resolver_test.go` - Task dependency resolution and validation tests
- `internal/assets/installer_advanced_test.go` - Advanced selective installation logic tests

**E2E Testing Strategy**:
All binary tests execute within isolated `e2e-test` subdirectories building on Story 08.01's testing patterns to ensure:

- Complete test isolation with task-specific scenarios
- Clean state for complex dependency testing
- IDE integration validation in isolated environments
- Multi-flag combination testing with proper cleanup

**Agent-Task Dependency Resolution Strategy**:
The implementation analyzes agent YAML definitions to extract task lists (e.g., PM agent: `create-prd.md`, `update-prd.md`) and validates task specifications against available tasks. Task dependencies are resolved through existing template/data reference parsing with enhanced validation for task-specific installations.

**IDE Integration Enhancement Strategy**:
Builds on existing IDE integration patterns (`CursorIntegration`, `ClaudeIntegration`, etc.) to generate IDE configurations that reflect only installed agents and their specified tasks, ensuring IDE environments match the selective installation scope.

The story maintains CLI consistency with the bundle command by using a single `--task` flag that supports comma-separated task lists (`create-prd,update-prd`). This extends the bundle pattern while preserving the familiar syntax and leveraging existing parsing approaches.

## Tasks/Subtasks

- [ ] **Task 1: Implement task-specific installation filtering using bundle command pattern (AC: 1, 3)**
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - add `--task` flag definition in init() function (line ~206)
  - [ ] Purpose: Add flag using cobra patterns exactly matching bundle command structure for consistency
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - import and reuse ParseAgentList() pattern for task parsing
  - [ ] Purpose: Create ParseTaskList() function following bundle.go:103-129 pattern for comma-separated task parsing
  - [ ] Create file: `internal/assets/task_resolver.go` - implement task dependency resolution system
  - [ ] Purpose: Analyze agent YAML files to extract task lists and validate task specifications against agent definitions
  - [ ] Edit file: `internal/assets/installer.go` - extend InstallSelective() method to support task filtering
  - [ ] Purpose: Build on Story 08.01's selective installation to filter tasks within agent installations
  - [ ] Create file: `cmd/krci-ai/cmd/install_advanced_test.go` - comprehensive task filtering tests
  - [ ] Unit Tests Required:
    - [ ] `TestInstallCommandHasTaskFlag()` - verify --task flag exists with correct properties
    - [ ] `TestParseTaskList()` - test comma-separated task parsing (reuse bundle patterns)
    - [ ] `TestAgentTaskValidation()` - verify tasks belong to specified agent
    - [ ] `TestTaskFilteringInstallation()` - test installation with task filtering
  - [ ] Run: `go build -o dist/krci-ai cmd/krci-ai/main.go` (follow Makefile build pattern)
  - [ ] Run: `make ci` (Expect: all CI checks pass including new task filtering tests)
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Verify: `../dist/krci-ai install --help | grep -E "(--task.*comma)"` (Expect: flag documented with comma-separated syntax)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: Task filtering implemented with full test coverage, all CI checks pass

- [ ] **Task 2: Add IDE integration for selective installations (AC: 2, 6)**
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - integrate task filtering with existing IDE integration logic
  - [ ] Purpose: Ensure IDE configurations reflect selective agent installations with task-specific setups
  - [ ] Edit file: `internal/assets/installer.go` - enhance IDE integration methods for selective installations
  - [ ] Purpose: Modify existing IDE integration patterns (Cursor, Claude, VS Code) to handle selective agents
  - [ ] Implementation: Extend existing IDE integration in installer.go:135-169 to filter agents based on installation scope
  - [ ] Create file: `cmd/krci-ai/cmd/install_ide_integration_test.go` - IDE integration with selective installations tests
  - [ ] Unit Tests Required:
    - [ ] `TestIDEIntegrationSelective()` - test IDE configuration with selective agent installations
    - [ ] `TestIDEConfigurationFiltering()` - verify IDE configs reflect only installed agents
    - [ ] `TestIDEIntegrationFailureRecovery()` - test IDE failure doesn't block agent installation
    - [ ] `TestMultiIDESelectiveInstallation()` - test multiple IDE integrations with selective agents
  - [ ] Run: `go test ./internal/assets/ -v -coverprofile=coverage.out` (verify comprehensive IDE integration test coverage)
  - [ ] Run: `make ci` (Expect: all CI checks pass with IDE integration tests)
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Verify: `../dist/krci-ai install --agent developer --ide cursor && test -f .cursor/rules/krci-ai/developer.mdc` (Expect: IDE file created)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: IDE integration enhanced with full test coverage, selective installations work with all IDEs

- [ ] **Task 3: Implement agent-task compatibility validation (AC: 3, 5)**
  - [ ] Create file: `internal/assets/task_resolver.go` - implement comprehensive agent-task validation system
  - [ ] Purpose: Parse agent YAML files to extract task lists and validate task specifications
  - [ ] Implementation: Analyze agent.tasks arrays to build agent-task mapping and validate user input
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - integrate agent-task validation before installation
  - [ ] Purpose: Prevent invalid agent-task combinations with clear error messages and suggestions
  - [ ] Create file: `internal/assets/task_resolver_test.go` - comprehensive task validation tests
  - [ ] Unit Tests Required:
    - [ ] `TestAgentTaskMapping()` - test extraction of tasks from agent YAML definitions
    - [ ] `TestValidateAgentTaskCompatibility()` - test agent-task compatibility validation
    - [ ] `TestAgentTaskValidationErrors()` - test error messages for invalid combinations
    - [ ] `TestTaskDependencyResolution()` - test task dependency resolution logic
  - [ ] Run: `go test ./internal/assets/ -v -run TaskResolver` (verify task resolution test coverage)
  - [ ] Run: `make ci` (Expect: all CI checks pass with validation tests)
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Verify: `../dist/krci-ai install --agent pm --task implement-feature; echo $?` (Expect: exit 1, validation error)
  - [ ] Verify: Error message shows available tasks for PM agent
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: Agent-task validation implemented with comprehensive error handling

- [ ] **Task 4: Add advanced error handling and recovery (AC: 4, 6)**
  - [ ] Edit file: `internal/cli/errors.go` - add task-specific and IDE-specific error messages following existing patterns
  - [ ] Purpose: Provide clear, actionable error messages for task and IDE integration failures
  - [ ] Edit file: `cmd/krci-ai/cmd/install.go` - implement IDE failure recovery (AC: 6)
  - [ ] Purpose: Ensure agent installation succeeds even if IDE configuration fails
  - [ ] Implementation: Isolate IDE configuration failures from core installation process
  - [ ] Edit file: `internal/assets/installer.go` - add rollback logic for complex installation failures
  - [ ] Purpose: Ensure clean state if partial installations fail during task filtering
  - [ ] Create file: `internal/assets/installer_advanced_test.go` - advanced error handling tests
  - [ ] Unit Tests Required:
    - [ ] `TestAdvancedErrorHandling()` - test task and IDE specific error scenarios
    - [ ] `TestIDEFailureRecovery()` - test agent installation continues when IDE setup fails
    - [ ] `TestPartialInstallationRollback()` - test rollback of complex installation failures
    - [ ] `TestErrorMessageClarity()` - verify error messages provide actionable guidance
  - [ ] Run: `go test ./internal/assets/ ./internal/cli/ -v -coverprofile=coverage.out` (verify error handling coverage)
  - [ ] Run: `make ci` (Expect: all CI checks pass with error handling tests)
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Verify: `../dist/krci-ai install --agent pm --task invalid-task; echo $?` (Expect: exit 1, clear error message)
  - [ ] Verify: `test ! -d .krci-ai` (Expect: no partial installation directory after error)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: Advanced error handling with complete recovery mechanisms

- [ ] **Task 5: Integration testing with Story 08.01 foundation (AC: 1, 2, 3)**
  - [ ] Create file: `cmd/krci-ai/cmd/install_integration_advanced_test.go` - integration tests building on 08.01
  - [ ] Unit Tests Required:
    - [ ] `TestStory0801Integration()` - verify 08.02 builds correctly on 08.01 foundation
    - [ ] `TestSelectiveInstallationWithTasks()` - test --agent + --task combinations
    - [ ] `TestIDEIntegrationWithSelection()` - test --agent + --task + --ide combinations
    - [ ] `TestValidationCompatibility()` - test advanced installations work with existing validation
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Run: `../dist/krci-ai install --agent architect --task review-sad,create-sad && ../dist/krci-ai validate --agent architect`
  - [ ] Purpose: Verify task-specific installation works with existing validation system
  - [ ] Verify: `echo $?` (Expect: 0 - validation passes with task filtering)
  - [ ] Run: `../dist/krci-ai install --agent pm --task create-prd,update-prd --force && ../dist/krci-ai bundle --agent pm --task create-prd`
  - [ ] Purpose: Verify task-specific installation works with existing bundle command
  - [ ] Verify: `test -f .krci-ai/bundle/pm-create-prd.md` (Expect: bundle generation works with task filtering)
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Run: `go test ./cmd/krci-ai/cmd/ -v -run Integration` (run integration tests specifically)
  - [ ] Run: `make ci` (Expect: complete CI pipeline passes with all integration tests)
  - [ ] Success Criteria: Advanced features integrate seamlessly with Story 08.01 foundation

- [ ] **Task 6: End-to-end multi-flag testing (All ACs)**
  - [ ] E2E Testing Setup: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)
  - [ ] Run: `../dist/krci-ai install --agent pm --task create-prd,update-prd --ide cursor` (all flags together)
  - [ ] Purpose: Verify complete feature integration with all advanced installation capabilities
  - [ ] Verify: Agent installed with only specified tasks, IDE configured correctly
  - [ ] Verify: `test -f .krci-ai/agents/pm.yaml && find .krci-ai/tasks -name "*prd*.md" | wc -l` (Expect: agent + 2 tasks)
  - [ ] Verify: `test -f .cursor/rules/krci-ai/pm.mdc` (Expect: IDE configuration created)
  - [ ] Run: `../dist/krci-ai validate --agent pm` (Expect: validation passes with task filtering)
  - [ ] Run: `../dist/krci-ai install --agent developer --task implement-feature --ide cursor --force` (test different agent)
  - [ ] Purpose: Verify multi-agent selective installations with task filtering
  - [ ] Verify: `find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: count = 2, both agents installed)
  - [ ] Verify: IDE shows both agents with correct task configurations
  - [ ] Cleanup: `cd .. && rm -rf e2e-test` (remove test environment)
  - [ ] Success Criteria: All advanced features work together seamlessly, complete Epic 8 functionality delivered

## Implementation Results

To be populated after implementation

## QA Checklist

### Functional Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Task-Specific Installation**: `../dist/krci-ai install --agent pm --task create-prd,update-prd` (Expect: success, only specified tasks installed, exit 0)
- [ ] **Task File Verification**: `find .krci-ai/tasks -name "*prd*.md" | wc -l` (Expect: count = 2, only specified tasks)
- [ ] **IDE Integration with Tasks**: `../dist/krci-ai install --agent developer --task implement-feature --ide cursor --force` (Expect: success, IDE configured correctly)
- [ ] **IDE Configuration Verification**: `test -f .cursor/rules/krci-ai/developer.mdc` (Expect: IDE file exists with selective agent config)
- [ ] **Complex Dependencies**: `../dist/krci-ai install --agent architect --task review-sad,create-sad --force` (Expect: success, dependencies resolved)
- [ ] **Dependency Validation**: `../dist/krci-ai validate --agent architect` (Expect: exit 0, all dependencies satisfied)
- [ ] **Advanced Error Handling**: `../dist/krci-ai install --agent pm --task invalid-task` (Expect: clear error message, exit 1)
- [ ] **Agent-Task Validation Error**: `../dist/krci-ai install --agent pm --task implement-feature` (Expect: validation error with task suggestions)
- [ ] **Clean State Verification**: `test ! -d .krci-ai` (Expect: no partial installation after error)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### Integration Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Story 8.01 Compatibility**: `../dist/krci-ai install --agent pm && ../dist/krci-ai install --agent developer --task implement-feature --force` (Expect: both installations coexist)
- [ ] **Multi-Agent Verification**: `find .krci-ai/agents -name "*.yaml" | wc -l` (Expect: count = 2, both agents installed)
- [ ] **IDE Integration Compatibility**: `../dist/krci-ai install --agent pm --task create-prd --ide cursor --force && ../dist/krci-ai install --agent developer --ide cursor --force` (Expect: multiple IDE configs coexist)
- [ ] **IDE Multi-Agent Verification**: `find .cursor/rules/krci-ai -name "*.mdc" | wc -l` (Expect: multiple agent IDE configs)
- [ ] **Validation Compatibility**: `../dist/krci-ai validate` (Expect: exit 0, advanced installations pass existing validation)
- [ ] **Bundle Command Compatibility**: `../dist/krci-ai bundle --agent pm --task create-prd` (Expect: exit 0, task filtering works with bundle)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### CI Pipeline Validation

- [ ] **Complete CI Pipeline**: `make ci` (Expect: exit 0, all checks pass - deps, fmt, vet, lint, staticcheck, test, build)
- [ ] **Test Coverage Verification**: `go test ./... -coverprofile=coverage.out && go tool cover -func=coverage.out` (Expect: >90% coverage for new advanced features)
- [ ] **Linting Compliance**: `make lint` (Expect: exit 0, no linting errors for new advanced features)
- [ ] **Static Analysis**: `make staticcheck` (Expect: exit 0, no static analysis issues)
- [ ] **Formatting Compliance**: `make fmt` (Expect: no formatting changes needed)
- [ ] **Build Verification**: `make build` (Expect: exit 0, binary created successfully)

### Unit Test Validation

- [ ] **Test File Coverage**: All new advanced functionality has dedicated test files (*_test.go)
- [ ] **Function Coverage**: All new public functions in task_resolver.go and advanced installation covered
- [ ] **Error Path Coverage**: All advanced error scenarios tested with appropriate assertions
- [ ] **Edge Case Coverage**: Invalid task combinations, IDE failures, and complex dependency scenarios tested
- [ ] **Integration Points**: All interactions with Story 08.01 foundation covered by integration tests

### Combined Feature Integration Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **All Flags Together**: `../dist/krci-ai install --agent pm --task create-prd,update-prd --ide cursor` (Expect: successful installation with all features working)
- [ ] **Complete Feature Verification**: `test -f .krci-ai/agents/pm.yaml && find .krci-ai/tasks -name "*prd*.md" | wc -l && test -f .cursor/rules/krci-ai/pm.mdc` (Expect: agent + 2 tasks + IDE config)
- [ ] **Cross-Agent Task Validation**: `../dist/krci-ai install --agent architect --task review-sad,create-sad --force && ../dist/krci-ai install --agent developer --task implement-feature --force` (Expect: multiple agents with different tasks)
- [ ] **Multi-Agent Task Verification**: `find .krci-ai/agents -name "*.yaml" | wc -l && find .krci-ai/tasks -name "*.md" | wc -l` (Expect: agents and their specific tasks only)
- [ ] **IDE Multi-Agent Setup**: `../dist/krci-ai install --agent pm --task create-prd --ide cursor --force && ../dist/krci-ai install --agent developer --task implement-feature --ide cursor --force` (Expect: multiple selective agents in IDE)
- [ ] **IDE Multi-Agent Verification**: `find .cursor/rules/krci-ai -name "*.mdc" | wc -l` (Expect: multiple agent IDE configurations)
- [ ] **Progressive Feature Addition**: `../dist/krci-ai install --agent pm --force && ../dist/krci-ai install --agent pm --task create-prd --force && ../dist/krci-ai install --agent pm --task create-prd --ide cursor --force` (Expect: progressive enhancement works)
- [ ] **End-to-End Workflow**: `../dist/krci-ai install --agent pm --task create-prd --ide cursor && ../dist/krci-ai validate && echo "Complete workflow test"` (Expect: full workflow completion)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### Epic-Level Integration Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Epic Acceptance Criteria Fulfillment**: All Epic 8 ACs validated through story combinations (install selective agents + install with tasks + IDE integration)
- [ ] **Bundle Command Consistency**: `../dist/krci-ai install --agent pm --task create-prd && ../dist/krci-ai bundle --agent pm --task create-prd` (Expect: same agents/tasks work in both commands)
- [ ] **Framework Compatibility**: `../dist/krci-ai install --agent pm --task create-prd --ide cursor && ../dist/krci-ai validate && ../dist/krci-ai list agents` (Expect: no regression in existing functionality)
- [ ] **User Journey Completion**: Complete Epic 8 user stories validation (Enterprise Development Lead + Focused Developer can achieve all goals)

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)

### Performance Testing

- [ ] **Task Installation Speed**: Task-specific installation completes in <= 15s
- [ ] **IDE Integration Speed**: IDE configuration completes in <= 20s
- [ ] **Complex Dependency Resolution**: Handles complex dependency graphs efficiently

### Security & Privacy

- [ ] **Task Validation**: Task names validated to prevent path traversal
- [ ] **IDE Configuration Security**: IDE files created with appropriate permissions
- [ ] **Dependency Integrity**: Task dependencies verified for integrity

### Edge Case Testing

**Setup**: `mkdir -p e2e-test && cd e2e-test` (create isolated test environment)

- [ ] **Invalid Agent-Task Combinations**: `../dist/krci-ai install --agent pm --task implement-feature` (Expect: validation error with available PM tasks listed)
- [ ] **Task Validation Error Message**: Error output shows available tasks for PM agent (create-prd, update-prd, create-project-brief, update-project-brief)
- [ ] **IDE Integration Failures**: Test with cursor unavailable - `../dist/krci-ai install --agent developer --task implement-feature --ide cursor` (Expect: agent installs, IDE skipped with guidance)
- [ ] **IDE Failure Recovery Verification**: `test -f .krci-ai/agents/developer.yaml && ! test -f .cursor/rules/krci-ai/developer.mdc` (Expect: agent exists, IDE config skipped)
- [ ] **Empty Task List**: `../dist/krci-ai install --agent pm --task ""` (Expect: graceful handling with clear error message)
- [ ] **Partial Failure Recovery**: `../dist/krci-ai install --agent nonexistent --task create-prd --ide cursor` (Expect: complete rollback, no partial state)
- [ ] **Rollback Verification**: `test ! -d .krci-ai` (Expect: no partial installation directory after failure)
- [ ] **Complex Dependency Failures**: Test with broken task dependencies (Expect: clear error guidance with dependency chain explanation)
- [ ] **Combined Flag Validation**: `../dist/krci-ai install --agent pm --task invalid-task --ide unsupported-ide` (Expect: comprehensive validation errors for all invalid flags)
- [ ] **Multi-Error Handling**: Error output shows validation errors for both task and IDE with specific guidance

**Cleanup**: `cd .. && rm -rf e2e-test` (remove test environment)
