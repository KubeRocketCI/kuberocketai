# Story 99.03: Local Agent Apply Command

## Status

| Field                  | Value                       |
|------------------------|-----------------------------|
| Status                 | Draft                       |
| Epic                   | Epic 99: Technical Debt Consolidation and Enhancement |
| Priority               | High                        |
| Estimated Story Points | 8                           |
| Jira                   | TBD                         |

## Dependencies

**Blocking:**

- None

**Blocked By:**

- None

**System/Test Dependencies:**

- Local .krci-ai framework installation
- Go 1.24.4+ for implementation
- Test agents for validation scenarios
- Multiple IDE directories for integration testing (.cursor, .claude, .github/chatmodes, .windsurf)

## Story

**As a** User,
**I want** a dedicated `krci-ai apply` command to propagate local `.krci-ai/agents` folder changes to IDE configurations,
**so that** I can rapidly iterate on custom agents and automatically update all IDE integrations without manual copy-paste work across multiple IDE configurations.

## Acceptance Criteria

1. **Apply Command Infrastructure**: Implement core `krci-ai apply` command with local agent processing and validation pipeline
2. **Local Agent Processing**: System processes all agents in `.krci-ai/agents` folder and regenerates IDE configurations
3. **Selective IDE Updates**: Command detects and regenerates ONLY existing IDE configuration directories (e.g., if only .cursor/rules/krci-ai exists, update only Cursor; never create new IDE integrations)
4. **IDE Detection Logic**: Apply command scans for existing IDE integration directories and processes only installed integrations, respecting user's IDE setup choices
5. **Validation Pipeline**: Comprehensive validation for agent YAML syntax, required fields, and IDE configuration consistency before applying changes

## Description

Users working with custom KubeRocketAI agents currently face friction when iterating on agent definitions. After modifying agents in the local `.krci-ai/agents` folder, users must manually regenerate IDE configurations for multiple environments (Cursor, Claude Code, VSCode, Windsurf), leading to error-prone copy-paste operations and inconsistent setups across users.

This story introduces a dedicated `krci-ai apply` command that serves as a local development workflow enhancement, completely separate from the standard installation process. The apply command focuses exclusively on regenerating IDE configurations from all agents in the local `.krci-ai/agents` folder to EXISTING IDE configurations only, enabling rapid iteration cycles for custom agent development without creating unwanted IDE integrations.

The implementation leverages the existing IDE integration system and agent discovery architecture, ensuring consistency with the established framework while providing users with a streamlined local development experience. This approach maintains clean separation between production installation workflows and local customization scenarios.

## Technical Context

The apply command builds upon the existing KubeRocketAI architecture components:

**Existing IDE Integration System**: The framework already implements a comprehensive IDE integration system with specific handlers for each supported IDE:
- CursorIntegration: Generates `.mdc` files in `.cursor/rules/krci-ai/`
- ClaudeIntegration: Creates `.md` files in `.claude/commands/krci-ai/`
- VSCodeIntegration: Produces `.chatmode.md` files in `.github/chatmodes/`
- WindsurfIntegration: Generates `.md` files in `.windsurf/rules/`

**Agent Discovery Architecture**: The `internal/assets/discovery.go` system provides filesystem-based agent detection and validation through the `Discovery` struct with `FilesystemSource` support. The apply command will leverage this existing discovery mechanism while bypassing embedded asset validation.

**Validation Framework**: The existing validation system in `internal/validation/` provides comprehensive framework analysis capabilities that will be used for validation scenarios, focusing on agent definition integrity and IDE configuration consistency.

The implementation follows the single responsibility principle by focusing solely on local change propagation, leaving installation and bundle management to their respective commands.

## Tasks/Subtasks

- [ ] **Task 1: Implement Apply Command Infrastructure (AC: 1)**
  - [ ] Create `cmd/krci-ai/cmd/apply.go` with command definition and flag parsing
  - [ ] Implement `ApplyCmd` struct with local filesystem validation and processing logic
  - [ ] Add apply command registration in `cmd/krci-ai/cmd/root.go` command tree
  - [ ] Implement comprehensive error handling with user-friendly error messages and recovery guidance
  - [ ] Create unit tests for apply command initialization and flag parsing scenarios
  - [ ] Command: `krci-ai apply --help` - Expected: help text showing apply command options

- [ ] **Task 2: Local Agent Processing and Validation System (AC: 2)**
  - [ ] Implement local agent discovery using existing `Discovery` with `FilesystemSource`
  - [ ] Create simple agent processing logic that regenerates IDE configurations for all agents in `.krci-ai/agents`
  - [ ] Implement/Reuse comprehensive YAML validation for agent definitions using existing validation framework
  - [ ] Create validation error reporting with specific agent file references and actionable correction guidance

- [ ] **Task 3: Selective IDE Integration Update Mechanism (AC: 3, 4)**
  - [ ] Implement IDE detection scanner to identify existing integration directories (.cursor, .claude, .github/chatmodes, .windsurf)
  - [ ] Create selective IDE configuration regeneration ONLY for detected/existing integrations
  - [ ] Implement apply-specific IDE orchestrator that skips non-existent IDE directories
  - [ ] Add comprehensive logging showing which IDEs were detected and updated

- [ ] **Task 4: End-to-End Scenario Testing (AC: 5)**
  - [ ] Create temporary test directory for isolated end-to-end validation
  - [ ] Build Go binary with new apply command implementation
  - [ ] **Scenario 1: Basic Apply Functionality** - Create test agents, run apply, verify IDE configurations are generated correctly
  - [ ] **Scenario 2: Selective IDE Updates** - Install only Cursor IDE integration, verify apply updates only Cursor (not Claude/VSCode/Windsurf)
  - [ ] **Scenario 3: Agent Changes Reflection** - Modify existing agent file, run apply, verify changes are reflected in all installed IDE configurations
  - [ ] **Scenario 4: YAML Schema Validation** - Create malformed agent YAML, verify apply fails with clear error message and doesn't corrupt existing configurations
  - [ ] **Scenario 5: Edge Cases Testing** - Test empty agents folder, missing .krci-ai directory, permission issues, and other edge cases
  - [ ] Command: `./dist/krci-ai apply` in test directory - Expected: all 5 scenarios pass with expected behaviors

## Implementation Results

*This section will be populated during implementation with actual results, command outputs, and evidence of successful apply command functionality.*

## QA Checklist

### Functional Testing

**Setup**: Ensure `.krci-ai` framework is installed in test directory with sample agents

- [ ] **Command Registration**: `krci-ai --help` shows apply command (Expect: apply command listed)
- [ ] **Basic Apply**: `krci-ai apply` with existing agents (Expect: all agents processed and IDE configurations regenerated, exit 0)
- [ ] **Agent Processing**: Modify agent file and run `krci-ai apply` (Expect: all agents processed and IDE configurations regenerated)
- [ ] **IDE File Generation**: Verify all IDE files created after apply (Expect: files in .cursor, .claude, .github, .windsurf)
- [ ] **YAML Validation**: Apply with malformed YAML (Expect: validation errors reported, exit non-zero)

### Integration Testing

- [ ] **Multiple IDEs**: Apply with all IDEs configured (Expect: consistent file generation across all platforms)
- [ ] **Agent Processing**: Apply multiple agents with various configurations (Expect: all agents processed correctly)
- [ ] **Performance**: Apply with multiple agents (Expect: reasonable completion time)
- [ ] **Multiple Agent Types**: Apply with different agent configurations (Expect: all processed correctly)

### Error Handling and Recovery

- [ ] **Missing Directory**: Apply without .krci-ai directory (Expect: clear error message with guidance)
- [ ] **Permission Issues**: Apply with read-only IDE directories (Expect: permission error handling and recovery)
- [ ] **Partial Failures**: Simulate IDE integration failure mid-process (Expect: clear error handling and graceful failure)
- [ ] **Recovery Operations**: Test error recovery and user guidance after failures (Expect: helpful error messages and recovery instructions)

### Cross-Platform Validation

- [ ] **macOS Testing**: Full apply workflow on macOS (Expect: consistent behavior)
- [ ] **Linux Testing**: Full apply workflow on Linux (Expect: consistent behavior)
- [ ] **Windows Testing**: Full apply workflow on Windows (Expect: consistent behavior)
- [ ] **Path Handling**: Test with spaces and special characters in paths (Expect: proper path handling)

### Security and Performance

- [ ] **File Permissions**: Generated IDE files have correct permissions (Expect: 644 for files, 755 for directories)
- [ ] **Resource Usage**: Monitor memory and CPU during apply operations (Expect: reasonable resource consumption)
- [ ] **Cleanup**: Verify no temporary files left after apply completion (Expect: clean filesystem state)
- [ ] **Resource Cleanup**: Verify proper cleanup of temporary resources during apply operations (Expect: no resource leaks or orphaned files)
