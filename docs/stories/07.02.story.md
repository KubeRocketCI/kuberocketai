# Story 07.02: Dependency Breakdown Analysis

## Status

| Field                  | Value                       |
|------------------------|-----------------------------|
| Status                 | Completed                   |
| Epic                   | Epic 7: Token Management    |
| Priority               | High                        |
| Estimated Story Points | 5                           |
| Jira                   | TBD                         |

<!-- Status tracking and Epic traceability -->
<!-- Enables progress monitoring and dependency validation -->

## Dependencies

**Blocking:**
- None

**Blocked By:**
- Story 07.01: Core Token Calculation Engine with CLI (completed)

**System/Test Dependencies:**
- Existing asset discovery and dependency tracking mechanisms from Epic 2
- Token calculation engine from Story 07.01
- Test agent configurations with complex dependency structures

<!-- Define precise dependencies for execution order and validation readiness -->

## Story

**As a** Software Architect,
**I want** detailed token breakdown by asset type and dependency chain analysis,
**so that** I can identify token-heavy components and optimize agent configurations for maximum efficiency while staying within platform context limits.

<!-- Standard story format focusing on persona, goal, and value -->
<!-- Must align with Epic Target Users and provide specific value -->

## Acceptance Criteria

1. **Asset Type Breakdown**: Command `krci-ai tokens --all` shows token distribution across agents, tasks, templates, and data files
   - Scenario: Given a project with multiple asset types, when running project-wide token analysis, then each asset type shows individual and total token contributions
   - Expected Behavior: Clear categorization with counts for agents, tasks, templates, and data files
   - Verification Command: `krci-ai tokens --all` (Expect: exit 0, breakdown table showing "Token Breakdown by Asset Type" in stdout)
   - Files Created/Changed: `internal/tokens/calculator.go` with `ProjectTokenInfo` and `TokenBreakdown` structs
   - Guardrails: Analysis completes within 30 seconds timeout for large projects
   - Test Data/Fixtures: Project with diverse asset types (agents, tasks, templates, data files)
   - Environment/Flags: `--all` flag for project-wide analysis
   - Evidence: Command output showing "🤖 Agents: X tokens", "📋 Tasks: X tokens", "📄 Templates: X tokens", "📊 Data Files: X tokens"
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; BR12

2. **Individual Agent Dependency Analysis**: Command `krci-ai tokens --agent <name>` shows detailed dependency breakdown for specific agent
   - Scenario: Given an agent with dependencies, when analyzing individual agent, then dependencies are categorized by type (tasks, templates, data files)
   - Expected Behavior: Hierarchical display showing agent file tokens and dependency breakdown by category
   - Verification Command: `krci-ai tokens --agent dev` (Expect: exit 0, dependency breakdown with "Dependencies:" section)
   - Files Created/Changed: `internal/tokens/calculator.go` with `AgentTokenInfo` struct containing dependencies
   - Guardrails: Individual agent analysis completes within 1 second for typical configurations
   - Test Data/Fixtures: Agent configurations with multiple task, template, and data dependencies
   - Environment/Flags: `--agent` flag for individual agent analysis
   - Evidence: Command output showing "📋 Tasks:", "📄 Templates:", "📊 Data Files:" with individual file token counts
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; BR12

3. **JSON Export Capability**: Commands support `--json` flag for machine-readable structured output
   - Scenario: Given any token analysis command, when using JSON flag, then output is well-formed JSON with complete breakdown data
   - Expected Behavior: Structured JSON output with agent info, dependencies, and breakdown data
   - Verification Command: `krci-ai tokens --all --json` (Expect: exit 0, valid JSON with total_tokens, agents array, breakdown object)
   - Files Created/Changed: JSON marshaling in `cmd/krci-ai/cmd/tokens.go` with `AgentTokenInfo` and `ProjectTokenInfo` JSON tags
   - Guardrails: JSON output validates against schema, includes all breakdown information
   - Test Data/Fixtures: Standard test configurations for JSON validation
   - Environment/Flags: `--json` flag for machine-readable output
   - Evidence: Valid JSON structure with fields like "total_tokens", "breakdown", "dependencies"
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; BR12

4. **File-Level Token Contribution**: Individual asset token counts shown with full file paths
   - Scenario: Given an agent with multiple dependencies, when running token analysis, then each referenced file shows individual token count and path
   - Expected Behavior: List of all referenced files with individual token counts and relative file paths
   - Verification Command: `krci-ai tokens --agent dev` (Expect: exit 0, individual files listed with paths and token counts)
   - Files Created/Changed: `AssetTokenInfo` struct in `internal/tokens/engine.go` with Path and Tokens fields
   - Guardrails: File-level analysis includes only accessible files, handles missing dependencies gracefully
   - Test Data/Fixtures: Agent with multiple task and template references
   - Environment/Flags: Standard `--agent` or `--all` flags provide file-level detail
   - Evidence: File paths like ".krci-ai/tasks/implement-feature.md (1098 tokens)" in output
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; BR12

5. **Performance Optimization**: Concurrent processing for multiple agents with reasonable completion times
   - Scenario: Given a project with multiple agents, when running project-wide analysis, then processing uses concurrent goroutines for efficiency
   - Expected Behavior: Parallel processing of agent token calculations without blocking
   - Verification Command: `time krci-ai tokens --all` (Expect: reasonable completion time for multiple agents)
   - Files Created/Changed: Concurrent processing in `internal/tokens/calculator.go` using `errgroup.WithContext`
   - Guardrails: Context timeout (30s) prevents indefinite hanging, error handling for failed goroutines
   - Test Data/Fixtures: Project with multiple agents (6+ agents for realistic testing)
   - Environment/Flags: Performance applies to all commands, especially `--all`
   - Evidence: Multiple agents processed efficiently as shown in project analysis output
   - Non-automatable at story-level: false
   - Traceability: Epic AC #1 (performance requirements)

6. **User-Friendly Error Handling**: Clear error messages and suggestions for common issues
   - Scenario: Given invalid agent names or missing files, when running token analysis, then clear error messages with suggestions are provided
   - Expected Behavior: User-friendly error messages with actionable suggestions for resolution
   - Verification Command: `krci-ai tokens --agent nonexistent` (Expect: clear error message, not raw error)
   - Files Created/Changed: Error handling in `cmd/krci-ai/cmd/tokens.go` with `FormatUserFriendlyError` and `SuggestSolutions`
   - Guardrails: JSON mode returns raw errors, interactive mode shows formatted errors with suggestions
   - Test Data/Fixtures: Test cases with invalid agent names, missing files, permission issues
   - Environment/Flags: Error handling applies to all commands
   - Evidence: Clear error messages with "💡 Suggestions:" section for common issues
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; user experience requirements

<!-- Specific, testable conditions that define completion at story level -->
<!-- Story ACs SHOULD include verification commands and expected outputs -->

## Description

This story successfully implemented advanced dependency breakdown analysis capabilities building on the foundational token calculation engine from Story 7.01. Software Architects now have granular visibility into how tokens are distributed across different asset types and dependency chains, enabling informed optimization decisions.

The implementation provides comprehensive token analysis through two main commands:
- `krci-ai tokens --all` for project-wide analysis with asset type breakdown
- `krci-ai tokens --agent <name>` for detailed individual agent dependency analysis

Key technical achievements include:
- **Asset Type Categorization**: Tokens are properly categorized across agents (🤖), tasks (📋), templates (📄), and data files (📊)
- **Dependency Tracking**: Complete dependency resolution showing individual file contributions with full paths
- **Performance Optimization**: Concurrent processing using goroutines and errgroup for efficient multi-agent analysis
- **Flexible Output**: Both human-readable table format and machine-readable JSON export
- **Error Handling**: User-friendly error messages with actionable suggestions

The implementation directly supports the Epic's goal of reducing token-related failures from 20% to under 5% by providing architects with the detailed visibility needed to identify token-heavy components before deployment. The breakdown analysis reveals exactly which assets contribute the most tokens, enabling targeted optimization efforts.

<!-- Context for why this story exists and its strategic importance -->
<!-- Provide background for implementation and Epic alignment -->

## Tasks/Subtasks

- [x] **Task 1: Asset Type Breakdown Implementation (AC: 1)**
  - [x] Create `TokenBreakdown` struct in `internal/tokens/engine.go` with agents, tasks, templates, data_files fields
  - [x] Enhance `internal/tokens/calculator.go` with `updateProjectBreakdown` method for asset type tracking
  - [x] Implement project-wide analysis in `CalculateAllTokens` method with breakdown calculation
  - [x] Create breakdown formatter in `outputProjectTokensTable` with emoji categorization (🤖📋📄📊)
  - [x] Validate breakdown: `krci-ai tokens --all` shows "Token Breakdown by Asset Type" section
  - [x] Performance: Analysis uses concurrent processing with errgroup for efficiency

- [x] **Task 2: Individual Agent Dependency Analysis (AC: 2)**
  - [x] Implement `AgentTokenInfo` struct with Dependencies containing Tasks, Templates, DataFiles arrays
  - [x] Create `calculateSingleAgentTokens` method with dependency resolution by asset type
  - [x] Implement dependency categorization in `calculateAssetTokens` method using filepath.Walk
  - [x] Create dependency formatter in `outputAgentTokensTable` with hierarchical display
  - [x] Add concurrent processing for dependency calculation using goroutines
  - [x] Validate dependency analysis: `krci-ai tokens --agent dev` shows categorized dependencies

- [x] **Task 3: JSON Export Implementation (AC: 3)**
  - [x] Add JSON tags to `AgentTokenInfo`, `ProjectTokenInfo`, `TokenBreakdown`, and `AssetTokenInfo` structs
  - [x] Implement `--json` flag in `cmd/krci-ai/cmd/tokens.go`
  - [x] Create `outputAgentTokensJSON` and `outputProjectTokensJSON` functions
  - [x] Add JSON marshaling with proper indentation using `json.MarshalIndent`
  - [x] Validate JSON output: `krci-ai tokens --all --json` produces valid JSON structure
  - [x] Ensure JSON contains complete breakdown data including dependencies

- [x] **Task 4: File-Level Token Contribution (AC: 4)**
  - [x] Create `AssetTokenInfo` struct with Path, Type, and Tokens fields
  - [x] Implement file-level tracking in asset calculation methods
  - [x] Add relative path display in token output showing full file paths
  - [x] Include individual file token counts in dependency breakdown
  - [x] Validate file-level analysis: Individual files shown with paths like ".krci-ai/tasks/implement-feature.md (1098 tokens)"
  - [x] Handle missing dependencies gracefully with error handling

- [x] **Task 5: Performance Optimization (AC: 5)**
  - [x] Implement concurrent processing using `golang.org/x/sync/errgroup` in `CalculateAllTokens`
  - [x] Add goroutine-based parallel agent processing with results channel
  - [x] Implement context timeout (30s) in CLI command execution
  - [x] Add mutex protection for shared data structures in concurrent operations
  - [x] Validate performance: Multiple agents processed efficiently in project analysis
  - [x] Error handling for failed goroutines with proper error propagation

- [x] **Task 6: User-Friendly Error Handling (AC: 6)**
  - [x] Implement `handleTokenError` function with conditional formatting based on JSON flag
  - [x] Add `FormatUserFriendlyError` and `SuggestSolutions` functions in tokens package
  - [x] Create agent validation in `ValidateAgentExists` method
  - [x] Add progress indicators for non-JSON output ("🔍 Analyzing tokens...")
  - [x] Implement error differentiation between JSON and interactive modes
  - [x] Validate error handling: Clear error messages with suggestions for invalid inputs

- [x] **Task 7: CLI Integration and Testing**
  - [x] Add mutually exclusive flags using `MarkFlagsMutuallyExclusive("agent", "all")`
  - [x] Create comprehensive CLI help documentation with examples
  - [x] Implement flag validation requiring either `--agent` or `--all`
  - [x] Create test files: `cmd/krci-ai/cmd/tokens_test.go` and `internal/tokens/calculator_test.go`
  - [x] Add integration with existing asset discovery system
  - [x] Validate CLI integration: Commands work seamlessly with existing CLI framework

<!-- LLM-executable implementation plan with atomic tasks and validation -->
<!-- Each task maps to acceptance criteria with specific commands and file paths -->

## Implementation Results

**Story Completion Status**: ✅ **COMPLETED**

### Evidence of Acceptance Criteria Fulfillment

**AC 1 - Asset Type Breakdown**: ✅ Verified
- Command: `krci-ai tokens --all`
- Evidence: Output shows "Token Breakdown by Asset Type:" with emoji categorization:
  - 🤖 Agents: 2819 tokens
  - 📋 Tasks: 31489 tokens  
  - 📄 Templates: 19689 tokens
  - 📊 Data Files: 12521 tokens
- Files Created: `TokenBreakdown` struct in `internal/tokens/engine.go`, breakdown logic in `internal/tokens/calculator.go`

**AC 2 - Individual Agent Dependency Analysis**: ✅ Verified
- Command: `krci-ai tokens --agent dev`
- Evidence: Output shows hierarchical dependency breakdown:
  - Agent Configuration: `.krci-ai/agents/dev.yaml (386 tokens)`
  - Dependencies section with categorized assets:
    - 📋 Tasks: `.krci-ai/tasks/review-story-dev.md (1062 tokens)`, etc.
    - 📄 Templates: `.krci-ai/templates/story.md (1777 tokens)`
    - 📊 Data Files: `.krci-ai/data/coding-standards.md (63 tokens)`, etc.
- Files Created: `AgentTokenInfo` struct with Dependencies field containing categorized arrays

**AC 3 - JSON Export Capability**: ✅ Verified  
- Command: `krci-ai tokens --all --json`
- Evidence: Valid JSON output with structured data including `total_tokens`, `agents` array, `breakdown` object
- Files Created: JSON tags on all structs, JSON marshaling functions in `cmd/krci-ai/cmd/tokens.go`

**AC 4 - File-Level Token Contribution**: ✅ Verified
- Command: `krci-ai tokens --agent dev`
- Evidence: Individual files listed with full paths and token counts:
  - `.krci-ai/tasks/implement-feature.md (1098 tokens)`
  - `.krci-ai/tasks/plan-story-implementation.md (1590 tokens)`
- Files Created: `AssetTokenInfo` struct with Path and Tokens fields

**AC 5 - Performance Optimization**: ✅ Verified
- Evidence: Concurrent processing implemented using `golang.org/x/sync/errgroup`
- Project analysis with 6 agents completes efficiently with parallel goroutine processing
- Files Created: Concurrent processing in `CalculateAllTokens` method with proper error handling

**AC 6 - User-Friendly Error Handling**: ✅ Verified
- Evidence: Error handling differentiated between JSON and interactive modes
- Progress indicators shown: "🔍 Analyzing tokens for agent 'dev'..."
- Files Created: `handleTokenError` function with `FormatUserFriendlyError` integration

### Files Created/Modified
- `cmd/krci-ai/cmd/tokens.go` - CLI command implementation with flags and output formatting
- `internal/tokens/calculator.go` - Core calculation logic with concurrent processing  
- `internal/tokens/engine.go` - Data structures (TokenBreakdown, AgentTokenInfo, ProjectTokenInfo, AssetTokenInfo)
- `cmd/krci-ai/cmd/tokens_test.go` - Comprehensive test coverage
- `internal/tokens/calculator_test.go` - Unit tests for calculation logic

### Commands Validated
- ✅ `krci-ai tokens --all` - Project-wide analysis with breakdown
- ✅ `krci-ai tokens --agent dev` - Individual agent dependency analysis
- ✅ `krci-ai tokens --all --json` - JSON export functionality
- ✅ Performance testing with concurrent processing for multiple agents

## QA Checklist

### Functional Testing
- [x] **Asset Type Breakdown**: Run `krci-ai tokens --all` - ✅ Verified: Shows "Token Breakdown by Asset Type" with emoji categorization (🤖📋📄📊)
- [x] **Individual Agent Analysis**: Run `krci-ai tokens --agent dev` - ✅ Verified: Shows hierarchical dependency breakdown with categorized assets
- [x] **JSON Export**: Run `krci-ai tokens --all --json` - ✅ Verified: Valid JSON structure with total_tokens, agents array, breakdown object
- [x] **File-Level Detail**: Run `krci-ai tokens --agent dev` - ✅ Verified: Individual files listed with paths and token counts
- [x] **Help Documentation**: Run `krci-ai tokens --help` - ✅ Verified: Comprehensive help with examples and flag descriptions
- [x] **Flag Validation**: Run `krci-ai tokens` without flags - ✅ Verified: Clear error requiring --agent or --all

### Performance Testing
- [x] **Project Analysis Performance**: Run `time krci-ai tokens --all` - ✅ Verified: Efficient concurrent processing for 6 agents
- [x] **Individual Agent Performance**: Run `time krci-ai tokens --agent dev` - ✅ Verified: Sub-second response time for single agent analysis
- [x] **Concurrent Processing**: Verify multiple agents processed in parallel - ✅ Verified: Uses errgroup.WithContext for concurrency
- [x] **Timeout Handling**: Verify 30-second context timeout - ✅ Verified: Context timeout implemented in CLI command

### Accuracy Testing
- [x] **Asset Type Accuracy**: Verify asset type categorization - ✅ Verified: Correct categorization of agents, tasks, templates, data files
- [x] **Dependency Completeness**: Verify all dependencies included - ✅ Verified: Complete dependency resolution showing all referenced assets
- [x] **Token Sum Validation**: Verify breakdown totals match overall counts - ✅ Verified: Mathematical consistency in token calculations
- [x] **Path Accuracy**: Verify file paths are correct and relative - ✅ Verified: Proper relative paths like ".krci-ai/tasks/implement-feature.md"

### Integration Testing
- [x] **CLI Integration**: Test flags with existing CLI framework - ✅ Verified: Seamless integration with cobra CLI and output handlers
- [x] **Asset Discovery Integration**: Verify compatibility with asset resolution - ✅ Verified: Uses existing DiscoveryInterface for agent and dependency resolution
- [x] **JSON/Table Output**: Test both output formats - ✅ Verified: Both JSON and table formats work correctly based on --json flag
- [x] **Error Handling**: Test with invalid agents - ✅ Verified: Clear error messages with user-friendly formatting

### Edge Case Testing
- [x] **Invalid Agent Names**: Test `krci-ai tokens --agent nonexistent` - ✅ Verified: Clear error message with suggestions
- [x] **Missing Dependencies**: Test agents with missing referenced files - ✅ Verified: Graceful handling of missing dependencies
- [x] **Empty Results**: Test agents with no dependencies - ✅ Verified: Shows "No dependencies found" message appropriately
- [x] **JSON vs Interactive Mode**: Test error handling in both modes - ✅ Verified: Different error formatting based on --json flag

<!-- Specific verification steps with commands and expected outputs -->
<!-- Enable automated testing and quality validation -->
