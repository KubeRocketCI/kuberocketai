# Story 99.01: Refactor Task Dependency Tracking System

## Status

| Field                  | Value                       |
|------------------------|-----------------------------|
| Status                 | Draft                       |
| Epic                   | Epic 99: Technical Debt Consolidation and Enhancement |
| Priority               | High                        |
| Estimated Story Points | 8                           |
| Jira                   | TBD                         |

## Dependencies

**Blocking:**

- Future task metadata consumption implementation

**Blocked By:**

- None

**System/Test Dependencies:**

- Access to all existing task files in framework
- Framework validation system for metadata parsing

## Story

**As a** Framework Developer,
**I want** a standardized metadata section at the top of each task file defining dependencies,
**so that** I can clearly track and manage dependencies for templates, data sources, and MCP servers without relying on existing fragmented dependency agreement approaches.

## Acceptance Criteria

1. **Metadata Section Implementation**
   - Scenario: Given a task file in the framework, when I review the file structure, then I see a YAML metadata section at the top defining dependencies or no section indicating no dependencies
   - Expected Behavior: YAML frontmatter present with dependency definitions or clean file without frontmatter
   - Verification Command: `find .krci-ai/tasks -name "*.md" -exec head -5 {} \; | grep -q "^---"` (Expect: exit 0, YAML frontmatter found)
   - Evidence: Command output showing YAML frontmatter detection across all task files
   - Non-automatable at story-level: false
   - Files Created/Changed: All files in `.krci-ai/tasks/*.md` updated with metadata sections
   - Guardrails: Migration completes in <= 30s; all files maintain proper YAML structure
   - Test Data/Fixtures: All existing task files in framework
   - Environment/Flags: Standard framework installation
   - Traceability: Epic AC #1; Technical debt reduction requirements

2. **Dependency Type Support**
   - Scenario: Given the metadata section format, when I define dependencies, then I can specify templates, data sources, MCP servers, and external dependencies using the standardized format
   - Expected Behavior: All dependency types supported with clear categorization and validation
   - Verification Command: `grep -r "dependencies:" .krci-ai/tasks/ | grep -E "(templates|data|mcp_servers|external)"` (Expect: exit 0, all types found)
   - Evidence: Grep output showing all four dependency types properly defined in metadata
   - Non-automatable at story-level: false
   - Files Created/Changed: Task files with comprehensive dependency type examples
   - Guardrails: Schema validation passes; no malformed YAML; all types properly documented
   - Test Data/Fixtures: Example configurations for each dependency type
   - Environment/Flags: Framework with validation capabilities
   - Traceability: Epic AC #1; Dependency management requirements

3. **Existing Task Migration (BREAKING CHANGE)**
   - Scenario: Given all existing tasks in the framework, when the migration is complete, then ALL tasks have been migrated to the new metadata format with no backward compatibility support
   - Expected Behavior: 100% migration completion; old dependency formats completely removed
   - Verification Command: `find .krci-ai/tasks -name "*.md" | wc -l && grep -r "^---" .krci-ai/tasks/ | wc -l` (Expect: equal counts, 100% migration)
   - Evidence: File count comparison showing complete migration coverage
   - Non-automatable at story-level: false
   - Files Created/Changed: All existing task files migrated to new format
   - Guardrails: No data loss during migration; complete rollback plan available; breaking change documented
   - Test Data/Fixtures: Backup of original task files for verification
   - Environment/Flags: Full framework with all existing tasks
   - Traceability: Epic AC #2; Breaking change requirements

4. **Framework Consumption (BREAKING CHANGE)**
   - Scenario: Given the new metadata format implementation, when the framework processes tasks, then it reads dependencies ONLY from the metadata section and completely removes support for old dependency approaches
   - Expected Behavior: Framework uses only new metadata format; old dependency parsing removed
   - Verification Command: `krci-ai validate` (Expect: exit 0, validation uses only new format)
   - Evidence: Validation output confirming new metadata consumption and old format rejection
   - Non-automatable at story-level: false
   - Files Created/Changed: Framework parsing logic updated to use only new metadata format
   - Guardrails: No regression in dependency resolution; clear error messages for old formats
   - Test Data/Fixtures: Test configurations with both old and new formats for validation
   - Environment/Flags: Updated framework with new parsing logic
   - Traceability: Epic AC #2; Framework modernization requirements

5. **Validation Engine Update**
   - Scenario: Given the updated validation engine, when framework validation runs on any task, then it enforces the new metadata dependency format and validates that all declared dependencies exist and are accessible
   - Expected Behavior: Validation engine fully supports new metadata format with comprehensive dependency checking
   - Verification Command: `krci-ai validate --verbose` (Expect: exit 0, detailed validation of metadata dependencies)
   - Evidence: Verbose validation output showing metadata-based dependency verification
   - Non-automatable at story-level: false
   - Files Created/Changed: Validation engine code updated for new metadata format
   - Guardrails: Validation performance maintained; all dependency types checked; clear error reporting
   - Test Data/Fixtures: Task configurations with valid and invalid dependency references
   - Environment/Flags: Framework with updated validation capabilities
   - Traceability: Epic AC #3; Validation requirements

6. **Breaking Change Communication**
   - Scenario: Given the breaking change implementation, when users attempt to use old dependency approaches, then they receive clear error messages directing them to the new metadata format
   - Expected Behavior: Clear, actionable error messages for old dependency format usage
   - Verification Command: Test with old format file and verify error message clarity
   - Evidence: Error message examples showing clear migration guidance
   - Non-automatable at story-level: true (requires manual testing of error scenarios)
   - Files Created/Changed: Error handling code with clear migration messages
   - Guardrails: User-friendly error messages; comprehensive migration documentation available
   - Test Data/Fixtures: Examples of old format files for testing error scenarios
   - Environment/Flags: Framework with new error handling implementation
   - Traceability: Epic AC #4; User experience requirements

## Description

The current dependency tracking system for tasks uses fragmented approaches that make it difficult to understand what dependencies each task requires. This creates maintenance overhead and prevents clear visibility into framework component relationships. A standardized metadata approach will enable better dependency management and future MCP server integration.

**BREAKING CHANGE**: This implementation will NOT preserve backward compatibility with existing dependency tracking approaches. All existing tasks will be migrated to the new metadata format, and users will be notified of this breaking change.

**Scope**: Add metadata section to all task files, define dependency types, migrate ALL existing tasks with no backward compatibility, update validation engine, establish parsing logic, update documentation, and notify users of breaking changes.

**Metadata Format**:

```yaml
---
dependencies:
  templates:
    - template-name.md
  data:
    - data-source.md
  mcp_servers:
    - server-name
  external:
    - external-dependency
---
```

## Tasks/Subtasks

- [ ] **Task 1: Design metadata format specification (AC: 1, 2)**
  - [ ] Create file: `.krci-ai/schemas/task-metadata.yaml` - YAML schema for task metadata
  - [ ] Edit file: `docs/architecture/04-data-models.md` - add dependency type specifications
  - [ ] Create file: `.krci-ai/docs/metadata-format.md` - validation rules and examples
  - [ ] Verify: `python scripts/validate-schema.py --schema task-metadata.yaml` (Expect: exit 0)

- [ ] **Task 2: Update framework parsing logic (AC: 3, 4)**
  - [ ] Edit file: `internal/engine/processor/yaml.go` - implement metadata section reader
  - [ ] Edit file: `internal/validation/dependency.go` - remove old dependency parsing completely
  - [ ] Create file: `internal/metadata/parser.go` - new metadata parsing logic
  - [ ] Run: `make test` (Expect: exit 0, all tests pass)
  - [ ] Verify: `krci-ai validate --check-breaking-changes` (Expect: old formats rejected)

- [ ] **Task 3: Migrate ALL existing tasks (AC: 3)**
  - [ ] Run: `scripts/audit-dependencies.sh` - audit current task dependency patterns
  - [ ] Run: `scripts/migrate-tasks.sh` - migrate ALL existing tasks to new metadata format
  - [ ] Edit file: `internal/assets/discovery.go` - remove backward compatibility support
  - [ ] Verify: `find .krci-ai/tasks -name "*.md" | xargs grep -L "^---"` (Expect: no output, 100% migration)
  - [ ] Rollback Plan: Restore from backup if migration validation fails

- [ ] **Task 4: Update validation engine (AC: 4, 5)**
  - [ ] Edit file: `internal/validation/analyzer.go` - enforce new metadata approach
  - [ ] Edit file: `internal/validation/dependency.go` - add dependency existence checks for new format
  - [ ] Edit file: `internal/validation/validation.go` - remove old dependency validation
  - [ ] Edit file: `internal/cli/errors.go` - update error reporting for metadata issues
  - [ ] Run: `make lint && make test` (Expect: exit 0, validation engine updated)
  - [ ] Verify: `krci-ai validate --verbose` (Expect: new metadata validation working)

- [ ] **Task 5: Documentation and user communication (AC: 6)**
  - [ ] Edit file: `docs/development.md` - update task creation guidelines with metadata requirements
  - [ ] Create file: `docs/breaking-changes/metadata-migration.md` - breaking change documentation
  - [ ] Create file: `.krci-ai/examples/metadata-examples.md` - proper metadata usage examples
  - [ ] Run: `make test-examples` (Expect: exit 0, all examples valid)
  - [ ] Create file: `MIGRATION_GUIDE.md` - user notification and migration guide
  - [ ] Verify: Documentation complete and accessible to users

## Implementation Results

*This section will be populated during implementation with actual results, metrics, and deliverables produced.*

## QA Checklist

### Functional Testing

**Setup**: `mkdir -p qa-test && cd qa-test` (create isolated test environment)

- [ ] **Metadata Section Verification**: `find .krci-ai/tasks -name "*.md" -exec head -5 {} \; | grep -c "^---"` (Expect: count = total task files)
- [ ] **Dependency Type Support**: `grep -r "dependencies:" .krci-ai/tasks/ | grep -E "(templates|data|mcp_servers|external)" | wc -l` (Expect: > 0, all types found)
- [ ] **Complete Migration**: `find .krci-ai/tasks -name "*.md" | wc -l && grep -r "^---" .krci-ai/tasks/ | wc -l` (Expect: equal counts, 100% migration)
- [ ] **New Format Only**: `krci-ai validate` (Expect: exit 0, uses only new metadata format)
- [ ] **Validation Enforcement**: `krci-ai validate --strict` (Expect: enforces new metadata requirements)

**Cleanup**: `cd .. && rm -rf qa-test` (remove test environment)

### Technical Testing

**Setup**: `mkdir -p tech-test && cd tech-test` (create isolated test environment)

- [ ] **YAML Parsing**: `python scripts/test-yaml-parsing.py` (Expect: exit 0, correct metadata extraction)
- [ ] **Dependency Validation**: `krci-ai validate --check-dependencies` (Expect: exit 0, all dependency types validated)
- [ ] **Old Format Rejection**: Test with old format file (Expect: clear error message, format rejected)
- [ ] **Framework Integration**: `krci-ai install --validate-metadata` (Expect: exit 0, metadata-based installation)
- [ ] **Validation Engine**: `krci-ai validate --verbose --metadata-only` (Expect: detailed metadata validation output)

**Cleanup**: `cd .. && rm -rf tech-test` (remove test environment)

### Integration Testing

- [ ] **CLI Framework**: All metadata commands integrate cleanly with existing CLI
- [ ] **YAML Infrastructure**: Metadata parsing works with existing YAML infrastructure
- [ ] **Validation Chain**: Complete validation workflow supports new metadata format
- [ ] **Error Handling**: Clear error messages for all metadata-related scenarios

### Performance Testing

- [ ] **Migration Speed**: Complete task migration completes in <= 30s for full framework
- [ ] **Validation Performance**: `time krci-ai validate` (Expect: completion time similar to previous version)
- [ ] **Memory Usage**: No memory leaks during metadata processing and validation

### Security & Privacy

- [ ] **Schema Validation**: YAML metadata follows defined schema with no injection risks
- [ ] **File Permissions**: Migrated files maintain appropriate permissions (0644 for files)
- [ ] **Path Validation**: Dependency paths validated against available framework assets

### Edge Case Testing

- [ ] **Empty Metadata**: `echo -e "---\n---\n# Task" > test-task.md && krci-ai validate test-task.md` (Expect: graceful handling)
- [ ] **Malformed YAML**: Test with broken YAML frontmatter (Expect: clear error message)
- [ ] **Missing Dependencies**: Reference non-existent files in metadata (Expect: validation failure with clear message)
- [ ] **Invalid Schema**: Use unsupported metadata fields (Expect: schema validation error)

## Traceability

**Epic Reference**: Epic 99: Technical Debt Consolidation and Enhancement

**Epic Acceptance Criteria**:

- Epic AC #1: Technical debt identification and remediation completed
- Epic AC #2: Framework modernization and breaking change implementation
- Epic AC #3: Enhanced validation and dependency management systems
- Epic AC #4: Clear communication and migration support for breaking changes

**Business Value**:

- Improved maintainability and clarity of framework component relationships
- Reduced technical debt through standardized dependency management
- Enhanced developer experience with clear dependency tracking
- Future-proofed architecture supporting MCP server integration

## Definition of Done

- [ ] ALL existing tasks migrated to new metadata format (100% migration)
- [ ] Framework reads dependencies from metadata sections ONLY (old approaches completely removed)
- [ ] Old dependency agreement approaches completely removed (BREAKING CHANGE)
- [ ] Validation engine updated to enforce new metadata approach
- [ ] Metadata format is validated by updated validation system
- [ ] Documentation updated with new metadata requirements and breaking change notice
- [ ] User notification created for breaking change and migration requirements
- [ ] All tests pass including new validation engine tests
- [ ] Code review completed and approved
- [ ] Breaking change properly communicated to users
