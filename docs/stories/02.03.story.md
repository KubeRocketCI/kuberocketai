# Story 02.03: Agent Prompt Engineering for Self-Validation

## Status

| Field                  | Value                |
|------------------------|----------------------|
| Status                 | Completed            |
| Epic                   | Epic 2 - Core Engine |
| Priority               | High                 |
| Estimated Story Points | 8                    |
| Jira                   | TBD                  |

## Dependencies

- **Story 2.1 Complete**: Asset Processing Engine required for runtime validation integration
- **Story 2.2 Complete**: Static Validation System required for two-tier validation architecture
- **Story 2.3 Complete**: CLI Enhancement required for runtime validation command integration

## Story

**As a** Framework Developer,
**I want** carefully crafted validation instructions and self-correction patterns embedded in agent prompts,
**so that** agents can self-validate their work, catch common errors, and correct themselves during execution without external intervention.

## Acceptance Criteria

1. Baseline validation instructions embedded in agent prompts for common error prevention
2. Self-correction prompt patterns that guide agents through error recovery scenarios
3. Context-aware validation reminders that adapt to different task complexities
4. Prompt templates with built-in validation checkpoints and self-assessment triggers
5. Error recognition patterns that help agents identify and classify their own mistakes
6. Recovery guidance patterns for handling partial failures and alternative approaches
7. Token-efficient validation instructions that minimize prompt overhead
8. Validation instruction library that can be mixed and matched for different agent types

## Tasks / Subtasks

- [x] **Task 1: Design Agent-Level Runtime Validation System (AC: 1, 3, 7)**
  - [x] Analyze existing agent activation_prompt structures across all 6 agent types
  - [x] Design minimal, flow-scoped validation instructions for agent prompts
  - [x] Create standardized validation pattern: "CRITICAL: When user selects a command, validate ONLY that command's required assets exist. If missing: HALT, report exact file, wait for user action."
  - [x] Implement validation instructions in all agent files (ba.yaml, architect.yaml, dev.yaml, pm.yaml, po.yaml, qa.yaml)
  - [x] Ensure token-efficient approach using concise validation prompts

- [x] **Task 2: Create Task-Level Reference Asset Validation (AC: 4, 6, 8)**
  - [x] Analyze all 21 task files to identify existing file dependencies
  - [x] Extract references to `./.krci-ai/data/` and `./.krci-ai/templates/` files
  - [x] Design standardized "Reference Assets" section for task Prerequisites
  - [x] Create explicit dependency lists with full paths for static analysis compatibility
  - [x] Implement validation instruction pattern for task-level checking

- [x] **Task 3: Implement Comprehensive Framework Asset Validation (AC: 2, 5, 6)**
  - [x] Add Reference Assets sections to all 21 task files with specific dependencies
  - [x] Create HALT behavior for missing assets with clear error reporting
  - [x] Implement recovery guidance through user action options (provide file, fix reference, abort)
  - [x] Ensure validation covers complete dependency chain for each task execution path
  - [x] Maintain existing task structure while adding validation capabilities

- [x] **Task 4: Optimize Validation for Production Use (AC: 3, 7)**
  - [x] Design context-aware validation that only checks selected command dependencies
  - [x] Avoid system-wide validation overhead by scoping to current execution flow
  - [x] Remove unnecessary formatting (emojis, bold text) for cleaner prompt processing
  - [x] Create explicit path resolution using `./.krci-ai/` relative paths
  - [x] Ensure validation instructions work with existing `{project_root}` resolution

## Description

This story implements the runtime validation layer of Epic 2's two-tier validation architecture through carefully crafted agent self-validation capabilities. Unlike the design-time validation of Stories 02.01 and 02.02, this story embeds validation instructions directly into agent prompts, enabling autonomous error detection and correction during agent execution. The self-healing validation approach reduces dependency on external validation tools while improving agent reliability and user experience through context-aware error recovery patterns.

## Implementation Results

### **Runtime Validation System Successfully Implemented**

#### **Agent-Level Validation (6 Files Updated)**

- **Files Modified**: All agent YAML files in `/cmd/krci-ai/assets/framework/core/agents/`
  - `ba.yaml` (Business Analyst)
  - `architect.yaml` (Software Architect)
  - `dev.yaml` (Software Developer)
  - `pm.yaml` (Product Manager)
  - `po.yaml` (Product Owner)
  - `qa.yaml` (QA Engineer)

- **Validation Pattern Implemented**:

  ```yaml
  activation_prompt:
    - "CRITICAL: When user selects a command, validate ONLY that command's required assets exist. If missing: HALT, report exact file, wait for user action."
    - "NEVER validate unused commands or proceed with broken references"
  ```

#### **Task-Level Validation (21 Files Updated)**

- **Files Modified**: All task files in `/cmd/krci-ai/assets/framework/core/tasks/`
- **Reference Assets Section Added**: Each task now includes explicit dependency validation

- **Standardized Format**:

  ```markdown
  ### Reference Assets

  Dependencies:
  - ./.krci-ai/data/specific-file.md
  - ./.krci-ai/templates/template-file.md

  Validation: Verify all dependencies exist at specified paths before proceeding. HALT if any missing.
  ```

#### **Technical Implementation Details**

- **Flow-Scoped Validation**: Agents only validate dependencies for the selected command/task
- **Explicit Path Resolution**: All dependencies use `./.krci-ai/` relative paths for consistency
- **Static Analysis Ready**: Structured dependency format enables automated validation tools
- **Zero Broken References**: LLMs cannot proceed with missing framework assets
- **User-Controlled Recovery**: Clear error messages with actionable resolution options

#### **Validation Coverage Achieved**

- **100% Agent Coverage**: All 6 agent types include runtime validation
- **100% Task Coverage**: All 21 task files include dependency validation
- **Deterministic Behavior**: Consistent validation logic across entire framework
- **Framework Integrity**: Maintains strict adherence to embedded asset structure

#### **Business Value Delivered**

- **Reduced Support Burden**: Agents self-validate and provide clear error guidance
- **Improved User Experience**: Users get specific, actionable error messages instead of cryptic failures
- **Framework Reliability**: Zero-tolerance approach to broken references ensures consistent behavior
- **Development Efficiency**: Developers can trust that agents will validate their execution environment

## QA Checklist

### Functional Testing

- [x] **Agent Validation Testing**: All 6 agent types halt execution when dependencies missing - Expected: Clear error message with missing file path
- [x] **Task Dependency Validation**: All 21 tasks validate their specific Reference Assets before execution - Expected: HALT behavior with specific file error
- [x] **Flow-Scoped Validation**: Agents only check dependencies for selected command, not entire system - Expected: No over-validation performance impact
- [x] **Path Resolution Consistency**: All dependencies use `./.krci-ai/` relative paths - Expected: Consistent path format across all files

### Integration Testing

- [x] **Agent-Task Integration**: Agent validation works with task-level validation without conflicts - Expected: Seamless validation chain from agent to task
- [x] **Static Analysis Compatibility**: Reference Assets format supports automated validation tools - Expected: Machine-readable dependency structure
- [x] **Framework Asset Integration**: Validation works with embedded asset system - Expected: Proper resolution of embedded framework files
- [x] **CLI Integration**: Validation instructions work with existing `{project_root}` resolution - Expected: Compatible with current CLI architecture

### Quality Assurance

- [x] **Implementation Coverage**: All acceptance criteria addressed through implemented solution - Expected: Complete AC satisfaction
- [x] **Code Quality**: Clean, consistent implementation across all agent and task files - Expected: Maintainable, standardized code
- [x] **Documentation Accuracy**: Implementation matches story requirements and technical specifications - Expected: Full alignment with story goals
- [x] **Framework Integrity**: No disruption to existing agent/task functionality - Expected: Backward compatibility maintained
