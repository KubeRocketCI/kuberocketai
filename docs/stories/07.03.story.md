# Story 07.03: Bundle Integration

## Status

| Field                  | Value                       |
|------------------------|-----------------------------|
| Status                 | Approved                    |
| Epic                   | Epic 7: Token Management    |
| Priority               | High                        |
| Estimated Story Points | 3                           |
| Jira                   | TBD                         |

<!-- Status tracking and Epic traceability -->
<!-- Enables progress monitoring and dependency validation -->

## Dependencies

**Blocking:**
- None

**Blocked By:**
- Story 07.01: Core Token Calculation Engine with CLI (completed)
- Epic 5: Bundle Management (bundle creation and dependency resolution)

**System/Test Dependencies:**
- Existing bundle command infrastructure from Epic 5
- Token calculation engine from Story 07.01
- Bundle generation and output formatting capabilities

<!-- Define precise dependencies for execution order and validation readiness -->

## Story

**As a** Developer,
**I want** token analysis for bundle configurations and integrated token reporting in bundle creation,
**so that** I can analyze bundle token usage with dedicated commands and see token counts when generating bundles for informed web chat decisions.

<!-- Standard story format focusing on persona, goal, and value -->
<!-- Must align with Epic Target Users and provide specific value -->

## Acceptance Criteria

1. **Bundle Token Analysis Command**: Command `krci-ai tokens --bundle <bundle_scope>` shows token count for specific bundle configurations
   - Scenario: Given a bundle configuration scope, when analyzing bundle tokens, then token count reflects the exact bundle content that would be generated
   - Expected Behavior: Token analysis matches the scope of bundle generation (dev agent, pm+architect agents, all agents)
   - Verification Command: `krci-ai tokens --bundle dev` (Expect: exit 0, token count for dev agent bundle configuration)
   - Files Created/Changed: Enhancement to `cmd/krci-ai/cmd/tokens.go` to add `--bundle` flag with bundle scope analysis
   - Guardrails: Bundle token analysis matches exactly what `krci-ai bundle --agent dev` would generate
   - Test Data/Fixtures: Various bundle configurations (single agent, multiple agents, all agents)
   - Environment/Flags: `--bundle` flag accepting bundle scope parameters (agent names, "all")
   - Evidence: `krci-ai tokens --bundle dev` shows token count matching bundle content for dev agent
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; BR12 (detailed dependency breakdown)

2. **Bundle Generation Token Summary**: Bundle creation commands show final token count message
   - Scenario: Given any bundle generation command, when bundle creation completes, then final token count is displayed at the end
   - Expected Behavior: Bundle generation shows token summary message after successful creation
   - Verification Command: `krci-ai bundle --agent pm,architect` (Expect: exit 0, final message showing total token count)
   - Files Created/Changed: Enhancement to `cmd/krci-ai/cmd/bundle.go` to show token summary after bundle creation
   - Guardrails: Token count message appears after "Bundle generated successfully" message
   - Test Data/Fixtures: Various bundle generation scenarios (all, specific agents, task-specific)
   - Environment/Flags: All bundle generation commands show token summary
   - Evidence: Bundle command output ending with "Bundle contains X tokens" or similar message
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; BR12

3. **Dry-Run Token Preview**: Command `krci-ai bundle --dry-run` shows token analysis without generating files
   - Scenario: Given any bundle command with dry-run flag, when previewing bundle scope, then token information is shown without file creation
   - Expected Behavior: Complete token analysis displayed with bundle scope preview
   - Verification Command: `krci-ai bundle --all --dry-run` (Expect: exit 0, token info shown, no files created)
   - Files Created/Changed: Enhancement to dry-run functionality to include token preview
   - Guardrails: Dry-run mode produces no files but shows complete token analysis
   - Test Data/Fixtures: Standard project configuration for dry-run testing
   - Environment/Flags: `--dry-run` flag enhanced with token analysis
   - Evidence: Token information displayed with "Bundle scope preview (dry-run mode)" message
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; user experience requirements

4. **Performance Integration**: Token calculation integrated without significant bundle generation slowdown
   - Scenario: Given bundle generation with token integration, when comparing performance to baseline, then overhead is minimal
   - Expected Behavior: Bundle generation with token analysis completes within reasonable time bounds
   - Verification Command: `time krci-ai bundle --all` (Expect: completion within baseline + 2 seconds)
   - Files Created/Changed: Efficient token calculation integration in bundle workflow
   - Guardrails: Token analysis uses existing calculated data when possible, avoids redundant computation
   - Test Data/Fixtures: Large project configuration for performance testing
   - Environment/Flags: Performance applies to all bundle generation commands
   - Evidence: Bundle generation time remains reasonable with token analysis enabled
   - Non-automatable at story-level: false
   - Traceability: Epic AC #1 (performance requirements)

5. **Error Handling Integration**: Token calculation errors are handled gracefully during bundle generation
   - Scenario: Given token calculation issues during bundle generation, when errors occur, then bundle generation continues with appropriate warnings
   - Expected Behavior: Bundle generation succeeds even if token analysis encounters non-critical errors
   - Verification Command: Bundle generation with missing dependencies (Expect: bundle created with token warning)
   - Files Created/Changed: Error handling integration in bundle command workflow
   - Guardrails: Token calculation errors do not prevent bundle generation for valid agents
   - Test Data/Fixtures: Test scenarios with missing dependencies or corrupted files
   - Environment/Flags: Error handling applies to all bundle generation scenarios
   - Evidence: Bundle generation succeeds with warning messages for token calculation issues
   - Non-automatable at story-level: false
   - Traceability: Epic AC #5; user experience requirements

<!-- Specific, testable conditions that define completion at story level -->
<!-- Story ACs SHOULD include verification commands and expected outputs -->

## Description

This story integrates the token calculation capabilities from Story 7.01 with the existing bundle management system from Epic 5. The integration provides developers with immediate token feedback during bundle creation, enabling informed decisions about bundle size before using them in web chat tools.

The integration focuses on enhancing the user experience of bundle generation by providing token visibility without disrupting the existing workflow. Developers can see token counts for their bundles, understand the size implications for different AI platforms, and make adjustments before deployment to web chat tools.

Key integration points include:
- **Bundle Command Enhancement**: Adding token reporting to existing bundle commands
- **Scoped Token Analysis**: Token counts that match the specific bundle being generated
- **Performance Optimization**: Efficient integration that doesn't slow down bundle generation
- **User Experience**: Clear token information displayed at appropriate points in the workflow

The implementation leverages the existing token calculation engine and bundle generation infrastructure, requiring minimal changes to core functionality while providing maximum value for bundle size awareness.

<!-- Context for why this story exists and its strategic importance -->
<!-- Provide background for implementation and Epic alignment -->

## Tasks/Subtasks

- [ ] **Task 1: Bundle Token Analysis Command (AC: 1)**
  - [ ] Enhance file: `cmd/krci-ai/cmd/tokens.go` to add `--bundle` flag
  - [ ] Implement bundle scope parsing (agent names, "all", multiple agents)
  - [ ] Integrate with existing bundle logic to determine exact bundle content
  - [ ] Add bundle-specific token calculation matching bundle generation scope
  - [ ] Validate bundle token analysis: Run `krci-ai tokens --bundle dev` - Expected: token count for dev agent bundle
  - [ ] Test various bundle scopes: single agent, multiple agents, all agents

- [ ] **Task 2: Bundle Generation Token Summary (AC: 2)**
  - [ ] Enhance file: `cmd/krci-ai/cmd/bundle.go` to add final token count message
  - [ ] Add token calculation after successful bundle creation
  - [ ] Display token summary message after "Bundle generated successfully"
  - [ ] Ensure token count matches the actual generated bundle content
  - [ ] Validate token summary: Run `krci-ai bundle --agent pm,architect` - Expected: final token count message
  - [ ] Test all bundle generation scenarios (all, agent-specific, task-specific)

- [ ] **Task 3: Dry-Run Token Preview Enhancement (AC: 3)**
  - [ ] Enhance dry-run functionality to include token analysis
  - [ ] Add token calculation to bundle scope preview without file generation
  - [ ] Format token preview output for dry-run mode
  - [ ] Validate dry-run integration: Run `krci-ai bundle --all --dry-run` - Expected: token info shown, no files created
  - [ ] Test various dry-run scenarios (all, agent-specific, task-specific)

- [ ] **Task 4: Error Handling Integration (AC: 5)**
  - [ ] Implement graceful error handling for token calculation issues
  - [ ] Ensure bundle generation continues even with token analysis errors
  - [ ] Add appropriate warning messages for token calculation problems
  - [ ] Validate error handling: Test bundle generation with missing dependencies
  - [ ] Test error scenarios while ensuring bundle generation succeeds

- [ ] **Task 5: Testing and Validation**
  - [ ] Create integration tests for `krci-ai tokens --bundle` command
  - [ ] Test bundle token analysis with various scopes (single agent, multiple agents, all)
  - [ ] Validate token counts match between `krci-ai tokens --bundle` and actual bundle generation
  - [ ] Create test scenarios for error handling and edge cases
  - [ ] Update CLI help documentation to reflect new `--bundle` flag and token integration
  - [ ] Run comprehensive testing: All bundle scenarios work with token information

<!-- LLM-executable implementation plan with atomic tasks and validation -->
<!-- Each task maps to acceptance criteria with specific commands and file paths -->

## Implementation Results

<!-- This section will be populated after story completion -->

<!-- Concrete outcomes populated AFTER completion (evidence-first) -->

## QA Checklist

### Functional Testing
- [ ] **Bundle Token Analysis Command**: Run `krci-ai tokens --bundle dev` - Expected: token count for dev agent bundle configuration
- [ ] **Multiple Agent Bundle Analysis**: Run `krci-ai tokens --bundle pm,architect` - Expected: token count for pm+architect bundle
- [ ] **All Agents Bundle Analysis**: Run `krci-ai tokens --bundle all` - Expected: token count for complete bundle
- [ ] **Bundle Generation Token Summary**: Run `krci-ai bundle --agent pm,architect` - Expected: final token count message after creation
- [ ] **Dry-Run Token Preview**: Run `krci-ai bundle --all --dry-run` - Expected: token info shown, no files created

- [ ] **Token Count Consistency**: Verify `krci-ai tokens --bundle dev` matches `krci-ai bundle --agent dev` token output

### Performance Testing
- [ ] **Bundle Generation Performance**: Run `time krci-ai bundle --all` - Expected: completion within baseline + 2 seconds
- [ ] **Large Project Performance**: Test bundle generation with token analysis on large projects
- [ ] **Memory Usage**: Monitor memory consumption during bundle generation with token analysis
- [ ] **Concurrent Operations**: Test multiple bundle generations with token analysis

### Integration Testing
- [ ] **Token Calculation Integration**: Verify token calculations use existing engine from Story 7.01
- [ ] **Bundle Command Compatibility**: Ensure all existing bundle flags work with token integration
- [ ] **Output Format Consistency**: Verify token information format matches other token commands
- [ ] **CLI Framework Integration**: Test integration with existing CLI output handlers

### Error Handling Testing
- [ ] **Missing Dependencies**: Test bundle generation with missing agent dependencies
- [ ] **Token Calculation Errors**: Test scenarios where token analysis fails but bundle generation continues
- [ ] **Invalid Agent Names**: Test bundle generation with invalid agents and token analysis
- [ ] **Permission Issues**: Test bundle generation with file permission problems

### Edge Case Testing
- [ ] **Empty Bundles**: Test token analysis with minimal bundle configurations
- [ ] **Large Bundles**: Test token analysis with maximum scope bundle generation
- [ ] **Custom Output Paths**: Test token integration with custom bundle output filenames
- [ ] **Multiple Agent Combinations**: Test various agent combinations with token analysis

<!-- Specific verification steps with commands and expected outputs -->
<!-- Enable automated testing and quality validation -->
