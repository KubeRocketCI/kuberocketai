# Story 10.01: MCP Discovery Implementation

## Status

| Field                  | Value                       |
|------------------------|-----------------------------|
| Status                 | Draft                       |
| Epic                   | Epic 10: MCP Server Management |
| Priority               | High                        |
| Estimated Story Points | 13                         |
| Jira                   | TBD                        |

## Dependencies

**Blocking:**

- None

**Blocked By:**

- Epic 2: Core Engine (YAML parsing infrastructure)
- Epic 3: Install Command (CLI framework)

**System/Test Dependencies:**

- Existing CLI framework and YAML parsing capabilities
- Framework with test agent and task configurations

## Story

**As a** Framework User,
**I want** to discover MCP server dependencies through CLI commands,
**so that** I can understand infrastructure requirements for my projects.

## Acceptance Criteria

1. **MCP server framework listing**
   - Scenario: Given framework with MCP dependencies, when user executes `krci-ai list mcp`, then all referenced servers are displayed with task mapping
   - Expected Behavior: Command shows complete list of MCP servers and which tasks reference them
   - Verification Command: `krci-ai list mcp` (Expect: exit 0, server list with task references)
   - Evidence: Command output showing comprehensive MCP server discovery
   - Non-automatable at story-level: false
   - Files Created/Changed: MCP discovery and CLI implementation
   - Guardrails: Command completes within 2 seconds; accurate server-to-task mapping
   - Test Data/Fixtures: Task files with MCP metadata examples
   - Environment/Flags: Standard framework installation
   - Traceability: Epic AC #1; BR16, NFR10

2. **Enhanced agent information with MCP dependencies**
   - Scenario: Given agents with MCP dependencies, when user runs `krci-ai list agents -v`, then verbose output includes MCP server information
   - Expected Behavior: Verbose mode shows MCP dependencies; standard mode unchanged
   - Verification Command: `krci-ai list agents -v` and verify MCP info presence
   - Evidence: Verbose output showing agent MCP dependencies
   - Non-automatable at story-level: false
   - Files Created/Changed: Enhanced agent listing with MCP integration
   - Guardrails: Backward compatibility maintained; no performance degradation
   - Test Data/Fixtures: Multi-agent configurations with varied MCP requirements
   - Environment/Flags: Framework with agent installations
   - Traceability: Epic AC #2; BR17, NFR11

3. **MCP validation integration**
   - Scenario: Given framework with MCP dependencies, when user runs `krci-ai validate`, then output includes MCP information
   - Expected Behavior: Validation seamlessly includes MCP dependency information
   - Verification Command: `krci-ai validate` (Expect: MCP info in standard output)
   - Evidence: Validation output with integrated MCP information
   - Non-automatable at story-level: false
   - Files Created/Changed: Enhanced validation with MCP reporting
   - Guardrails: Existing validation unchanged; no latency impact
   - Test Data/Fixtures: Framework configurations for validation testing
   - Environment/Flags: Standard validation environment
   - Traceability: Epic AC #3; BR18, NFR11

## Description

This story implements MCP server discovery across the KubeRocketAI framework, enabling users to understand infrastructure dependencies through intuitive CLI commands. The implementation includes metadata format definition, parsing infrastructure, discovery engine, and CLI integration to deliver a complete MCP dependency management solution.

The solution enables task authors to specify MCP server dependencies and provides users with three discovery methods: dedicated listing, enhanced agent information, and integrated validation reporting.

## MCP Metadata Format Vision

**Proposed approach for architect/developer refinement:**

### Task File Integration

```yaml
---
# Standard task metadata
task:
  name: "create-prd"
  description: "Create product requirements document"

# MCP server dependencies
mcp_servers:
  - name: "filesystem"
    description: "File system operations for document creation"
    required: true
  - name: "git"
    description: "Git operations for version control"
    required: false
---

# Task content follows...
```

### Discovery Output Examples

```bash
$ krci-ai list mcp
MCP Servers in Framework:
├── filesystem (required by: create-prd, update-prd, create-story)
├── git (optional for: create-prd, required by: update-story)
└── github (required by: create-github-issues)

$ krci-ai list agents -v
Agent: PM (Product Manager)
├── Tasks: create-prd, update-prd
├── MCP Dependencies: filesystem (required), git (optional)
└── Templates: prd-template.md, project-brief-template.md

$ krci-ai validate
Framework Validation Results:
✓ Agent definitions valid (6/6)
✓ Task references resolved (23/23)
✓ Template dependencies met (15/15)
ℹ MCP Dependencies:
  └── Required: filesystem, github
  └── Optional: git
```

### Design Principles

- **Simple**: Just server names and basic metadata
- **Extensible**: Can add version requirements, configuration later
- **Backward compatible**: Tasks without MCP metadata work unchanged
- **Discoverable**: Easy to query and display across CLI commands

*Note: This format is a starting proposal for architect/developer collaboration and refinement.*

## Tasks/Subtasks

- [ ] **Task 1: Define MCP metadata format (AC: 1, 2, 3)**
  - [ ] Design YAML structure for MCP server specifications in task frontmatter
  - [ ] Create simple, extensible format (server name + basic metadata)
  - [ ] Document format with examples and usage guidelines
  - [ ] Verify: Format is clear, extensible, and backward compatible

- [ ] **Task 2: Implement MCP metadata parsing (AC: 1, 2, 3)**
  - [ ] Create MCP metadata extraction from task YAML frontmatter
  - [ ] Implement backward-compatible parsing (existing tasks unaffected)
  - [ ] Add comprehensive error handling for malformed metadata
  - [ ] Verify: Parser correctly extracts MCP metadata with graceful error handling

- [ ] **Task 3: Build MCP discovery engine (AC: 1, 2, 3)**
  - [ ] Implement framework-wide MCP server discovery logic
  - [ ] Create efficient data structures for server-to-task mapping
  - [ ] Add performance optimization (caching, parallel processing)
  - [ ] Verify: Discovery engine meets 2-second performance requirement

- [ ] **Task 4: Implement `krci-ai list mcp` command (AC: 1)**
  - [ ] Create MCP list command with clean output formatting
  - [ ] Display server-to-task mapping and dependency information
  - [ ] Add command help text and usage documentation
  - [ ] Verify: Command produces clear, actionable MCP server listing

- [ ] **Task 5: Enhance `krci-ai list agents -v` with MCP info (AC: 2)**
  - [ ] Extend agent listing to include MCP information in verbose mode
  - [ ] Ensure backward compatibility for standard agent listing
  - [ ] Format MCP information clearly within agent context
  - [ ] Verify: Verbose mode enhanced; standard mode unchanged

- [ ] **Task 6: Integrate MCP reporting in `krci-ai validate` (AC: 3)**
  - [ ] Add MCP dependency information to validation output
  - [ ] Ensure seamless integration without performance impact
  - [ ] Maintain existing validation flow and functionality
  - [ ] Verify: Validation enhanced with MCP info; existing behavior preserved

- [ ] **Task 7: Add comprehensive testing and error handling (AC: 1, 2, 3)**
  - [ ] Create test fixtures with varied MCP metadata scenarios
  - [ ] Implement error handling for missing files, malformed metadata
  - [ ] Add performance testing for large framework configurations
  - [ ] Verify: Comprehensive test coverage and robust error handling

## Implementation Results

To be populated after implementation completion.

## QA Checklist

### Functional Requirements

- [ ] `list mcp` Command: Displays all MCP servers with accurate task mapping
- [ ] `list agents -v` Enhancement: Shows MCP info in verbose mode only
- [ ] `validate` Integration: Includes MCP information in standard validation output
- [ ] MCP Metadata: Task files support MCP server specifications

### Performance & Compatibility

- [ ] Discovery Performance: All MCP commands complete within 2 seconds
- [ ] Backward Compatibility: Existing commands and tasks work unchanged
- [ ] Error Handling: Clear messages for all MCP-related error scenarios
- [ ] Cross-Platform: Consistent behavior across operating systems

### Integration Quality

- [ ] CLI Framework: MCP commands integrate cleanly with existing CLI
- [ ] YAML Parsing: MCP metadata parsing works with existing infrastructure
- [ ] Framework Compatibility: Works across different framework configurations
- [ ] Help Integration: All commands show appropriate help text

### Data Quality & Accuracy

- [ ] Metadata Parsing: MCP server specifications extracted correctly
- [ ] Discovery Accuracy: All MCP dependencies identified and mapped accurately
- [ ] Output Consistency: MCP information formatted consistently across commands
- [ ] Edge Case Handling: Empty frameworks, missing metadata handled gracefully
